<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock AI Advisor - ä¸“ä¸šçº§è‚¡ç¥¨æŠ•èµ„AIåŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .error-shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-chart-line text-2xl"></i>
                    <h1 class="text-2xl font-bold">Stock AI Advisor</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm opacity-90">ä¸“ä¸šçº§è‚¡ç¥¨æŠ•èµ„AIåŠ©æ‰‹</span>
                    <i class="fas fa-robot text-xl"></i>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Navigation Tabs -->
        <div class="bg-white shadow rounded-lg mb-8">
            <nav class="flex border-b">
                <button id="tabStock" class="tab-btn px-6 py-4 font-semibold text-blue-600 tab-active">
                    <i class="fas fa-chart-candlestick mr-2"></i>è‚¡ç¥¨åˆ†æ
                </button>
                <button id="tabFundamental" class="tab-btn px-6 py-4 font-semibold text-gray-600 hover:text-blue-600">
                    <i class="fas fa-calculator mr-2"></i>åŸºæœ¬é¢åˆ†æ
                </button>
                <button id="tabRisk" class="tab-btn px-6 py-4 font-semibold text-gray-600 hover:text-blue-600">
                    <i class="fas fa-shield-alt mr-2"></i>é£é™©ç®¡ç†
                </button>
                <button id="tabPortfolio" class="tab-btn px-6 py-4 font-semibold text-gray-600 hover:text-blue-600">
                    <i class="fas fa-briefcase mr-2"></i>æŠ•èµ„ç»„åˆ
                </button>
            </nav>
        </div>

        <!-- Stock Analysis Tab -->
        <div id="stockTab" class="tab-content">
            <!-- Market Overview -->
            <div class="bg-white shadow rounded-lg p-6 mb-8">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i class="fas fa-globe-americas mr-3 text-blue-600"></i>å¸‚åœºæ¦‚è§ˆ
                </h2>
                <div id="marketLoading" class="text-center py-8">
                    <i class="fas fa-spinner loading text-2xl text-blue-600"></i>
                    <p class="mt-2 text-gray-600">æ­£åœ¨åŠ è½½å¸‚åœºæ•°æ®...</p>
                </div>
                <div id="marketData" class="hidden">
                    <div id="indices" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="font-semibold mb-3 text-green-800 flex items-center">
                                <i class="fas fa-arrow-up mr-2"></i>æ¶¨å¹…æ¦œ
                            </h3>
                            <ul id="gainers" class="space-y-2"></ul>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h3 class="font-semibold mb-3 text-red-800 flex items-center">
                                <i class="fas fa-arrow-down mr-2"></i>è·Œå¹…æ¦œ
                            </h3>
                            <ul id="losers" class="space-y-2"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stock Search -->
            <div class="bg-white shadow rounded-lg p-6 mb-8">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-search mr-3 text-blue-600"></i>è‚¡ç¥¨æŸ¥è¯¢
                </h3>
                <div class="flex gap-3 mb-4">
                    <input id="ticker" type="text" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚: AAPL, 00700.HK)" 
                           class="flex-1 border-2 border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition-colors">
                    <button id="searchBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-search mr-2"></i>æŸ¥è¯¢
                    </button>
                </div>
                
                <!-- Period Selector -->
                <div id="periodSelector" class="flex flex-wrap gap-2 mb-6 hidden">
                    <span class="text-sm font-medium text-gray-700 self-center mr-2">æ—¶é—´å‘¨æœŸ:</span>
                    <button class="period-btn px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 text-sm" data-period="1d">1æ—¥</button>
                    <button class="period-btn px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 text-sm" data-period="1wk">1å‘¨</button>
                    <button class="period-btn px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 text-sm" data-period="1mo">1æœˆ</button>
                    <button class="period-btn px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 text-sm" data-period="3mo">3æœˆ</button>
                    <button class="period-btn px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 text-sm" data-period="6mo">6æœˆ</button>
                    <button class="period-btn px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 text-sm" data-period="1y">1å¹´</button>
                    <button class="period-btn px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 text-sm" data-period="2y">2å¹´</button>
                </div>

                <!-- Loading State -->
                <div id="searchLoading" class="text-center py-8 hidden">
                    <i class="fas fa-spinner loading text-2xl text-blue-600"></i>
                    <p class="mt-2 text-gray-600">æ­£åœ¨åˆ†æè‚¡ç¥¨æ•°æ®...</p>
                </div>

                <!-- Stock Result -->
                <div id="result" class="hidden">
                    <div class="flex items-center gap-4 mb-6">
                        <div id="badge" class="px-4 py-2 rounded-lg text-white text-lg font-bold"></div>
                        <div>
                            <h2 id="tickerLabel" class="text-2xl font-bold"></h2>
                            <p id="priceInfo" class="text-gray-600"></p>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <h4 class="font-semibold mb-2 text-blue-800">AIå†³ç­–åˆ†æ</h4>
                        <ul id="reasonsList" class="space-y-1"></ul>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <canvas id="priceChart" height="100"></canvas>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="bg-white p-4 rounded border text-center">
                            <p class="text-sm text-gray-600">å½“å‰ä»·æ ¼</p>
                            <p id="price" class="text-lg font-bold"></p>
                        </div>
                        <div class="bg-white p-4 rounded border text-center">
                            <p class="text-sm text-gray-600">å¼€ç›˜ä»·</p>
                            <p id="open" class="text-lg font-bold"></p>
                        </div>
                        <div class="bg-white p-4 rounded border text-center">
                            <p class="text-sm text-gray-600">æœ€é«˜ä»·</p>
                            <p id="high" class="text-lg font-bold text-green-600"></p>
                        </div>
                        <div class="bg-white p-4 rounded border text-center">
                            <p class="text-sm text-gray-600">æœ€ä½ä»·</p>
                            <p id="low" class="text-lg font-bold text-red-600"></p>
                        </div>
                        <div class="bg-white p-4 rounded border text-center">
                            <p class="text-sm text-gray-600">æˆäº¤é‡</p>
                            <p id="volume" class="text-lg font-bold"></p>
                        </div>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="errorMessage" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span id="errorText"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fundamental Analysis Tab -->
        <div id="fundamentalTab" class="tab-content hidden">
            <div class="bg-white shadow rounded-lg p-6 mb-8">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i class="fas fa-calculator mr-3 text-blue-600"></i>åŸºæœ¬é¢åˆ†æ
                </h2>
                
                <!-- Input Section -->
                <div class="flex gap-3 mb-6">
                    <input id="fundamentalTicker" type="text" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚: AAPL)" 
                           class="flex-1 border-2 border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition-colors">
                    <button id="fundamentalSearchBtn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-chart-pie mr-2"></i>åˆ†æ
                    </button>
                </div>

                <!-- Loading State -->
                <div id="fundamentalLoading" class="text-center py-8 hidden">
                    <i class="fas fa-spinner loading text-2xl text-green-600"></i>
                    <p class="mt-2 text-gray-600">æ­£åœ¨åˆ†æåŸºæœ¬é¢æ•°æ®...</p>
                </div>

                <!-- Results -->
                <div id="fundamentalResults" class="hidden">
                    <!-- Company Info -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <h3 id="companyName" class="text-xl font-bold mb-2"></h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">è¡Œä¸š</p>
                                <p id="companySector" class="font-semibold"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">å¸‚å€¼</p>
                                <p id="marketCap" class="font-semibold"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">P/Eæ¯”ç‡</p>
                                <p id="peRatio" class="font-semibold"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">P/Bæ¯”ç‡</p>
                                <p id="pbRatio" class="font-semibold"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Health Score -->
                    <div class="bg-blue-50 p-6 rounded-lg mb-6">
                        <h4 class="text-lg font-bold mb-4 text-blue-800">è´¢åŠ¡å¥åº·åº¦è¯„åˆ†</h4>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <div id="overallScore" class="text-3xl font-bold text-blue-600 mb-1"></div>
                                <p class="text-sm text-gray-600">æ€»ä½“è¯„åˆ†</p>
                            </div>
                            <div class="text-center">
                                <div id="profitabilityScore" class="text-2xl font-bold text-green-600 mb-1"></div>
                                <p class="text-sm text-gray-600">ç›ˆåˆ©èƒ½åŠ›</p>
                            </div>
                            <div class="text-center">
                                <div id="liquidityScore" class="text-2xl font-bold text-yellow-600 mb-1"></div>
                                <p class="text-sm text-gray-600">æµåŠ¨æ€§</p>
                            </div>
                            <div class="text-center">
                                <div id="leverageScore" class="text-2xl font-bold text-purple-600 mb-1"></div>
                                <p class="text-sm text-gray-600">è´¢åŠ¡æ æ†</p>
                            </div>
                            <div class="text-center">
                                <div id="efficiencyScore" class="text-2xl font-bold text-indigo-600 mb-1"></div>
                                <p class="text-sm text-gray-600">è¿è¥æ•ˆç‡</p>
                            </div>
                            <div class="text-center">
                                <div id="growthScore" class="text-2xl font-bold text-pink-600 mb-1"></div>
                                <p class="text-sm text-gray-600">æˆé•¿æ€§</p>
                            </div>
                        </div>
                    </div>

                    <!-- Strengths and Weaknesses -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h5 class="font-bold text-green-800 mb-3">âœ… ä¼˜åŠ¿</h5>
                            <ul id="strengthsList" class="space-y-1 text-green-700"></ul>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h5 class="font-bold text-red-800 mb-3">âš ï¸ åŠ£åŠ¿</h5>
                            <ul id="weaknessesList" class="space-y-1 text-red-700"></ul>
                        </div>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="fundamentalError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span id="fundamentalErrorText"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Management Tab -->
        <div id="riskTab" class="tab-content hidden">
            <div class="bg-white shadow rounded-lg p-6 mb-8">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i class="fas fa-shield-alt mr-3 text-blue-600"></i>é£é™©ç®¡ç†
                </h2>
                
                <!-- Input Section -->
                <div class="flex gap-3 mb-6">
                    <input id="riskTicker" type="text" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚: AAPL)" 
                           class="flex-1 border-2 border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition-colors">
                    <button id="riskAnalyzeBtn" class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-shield-alt mr-2"></i>é£é™©åˆ†æ
                    </button>
                </div>

                <!-- Loading State -->
                <div id="riskLoading" class="text-center py-8 hidden">
                    <i class="fas fa-spinner loading text-2xl text-red-600"></i>
                    <p class="mt-2 text-gray-600">æ­£åœ¨åˆ†æé£é™©æ•°æ®...</p>
                </div>

                <!-- Results -->
                <div id="riskResults" class="hidden">
                    <!-- Risk Overview -->
                    <div class="bg-red-50 p-6 rounded-lg mb-6">
                        <h4 class="text-lg font-bold mb-4 text-red-800">é£é™©è¯„ä¼°æ¦‚è§ˆ</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="text-center">
                                <div id="riskLevel" class="text-3xl font-bold mb-2"></div>
                                <p class="text-sm text-gray-600">é£é™©ç­‰çº§</p>
                            </div>
                            <div class="text-center">
                                <div id="riskScore" class="text-3xl font-bold mb-2"></div>
                                <p class="text-sm text-gray-600">é£é™©è¯„åˆ†</p>
                            </div>
                            <div class="text-center">
                                <div id="volatility" class="text-3xl font-bold mb-2"></div>
                                <p class="text-sm text-gray-600">å¹´åŒ–æ³¢åŠ¨ç‡</p>
                            </div>
                        </div>
                    </div>

                    <!-- VaR Analysis -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h5 class="font-bold text-orange-800 mb-3">ğŸ“Š VaRé£é™©ä»·å€¼</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span>95%ç½®ä¿¡åº¦VaR:</span>
                                    <span id="var95" class="font-bold"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>99%ç½®ä¿¡åº¦VaR:</span>
                                    <span id="var99" class="font-bold"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>å†å²æœ€å¤§å•æ—¥è·Œå¹…:</span>
                                    <span id="worstDay" class="font-bold text-red-600"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h5 class="font-bold text-purple-800 mb-3">ğŸ“ˆ å›æ’¤åˆ†æ</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span>æœ€å¤§å›æ’¤:</span>
                                    <span id="maxDrawdown" class="font-bold text-red-600"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>å½“å‰å›æ’¤:</span>
                                    <span id="currentDrawdown" class="font-bold"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>å¹³å‡æ¢å¤æ—¶é—´:</span>
                                    <span id="recoveryTime" class="font-bold"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Position Sizing -->
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <h5 class="font-bold text-blue-800 mb-3">ğŸ’° ä»“ä½å»ºè®®</h5>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center">
                                <div id="conservativePosition" class="text-xl font-bold text-green-600"></div>
                                <p class="text-sm">ä¿å®ˆå»ºè®®</p>
                            </div>
                            <div class="text-center">
                                <div id="recommendedPosition" class="text-xl font-bold text-blue-600"></div>
                                <p class="text-sm">æ¨èå»ºè®®</p>
                            </div>
                            <div class="text-center">
                                <div id="aggressivePosition" class="text-xl font-bold text-orange-600"></div>
                                <p class="text-sm">æ¿€è¿›å»ºè®®</p>
                            </div>
                            <div class="text-center">
                                <div id="kellyPosition" class="text-xl font-bold text-purple-600"></div>
                                <p class="text-sm">å‡¯åˆ©å…¬å¼</p>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Warnings -->
                    <div id="riskWarnings" class="bg-yellow-50 p-4 rounded-lg">
                        <h5 class="font-bold text-yellow-800 mb-3">âš ï¸ é£é™©æç¤º</h5>
                        <ul id="riskWarningsList" class="space-y-1 text-yellow-700"></ul>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="riskError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span id="riskErrorText"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Tab -->
        <div id="portfolioTab" class="tab-content hidden">
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i class="fas fa-briefcase mr-3 text-blue-600"></i>æŠ•èµ„ç»„åˆç®¡ç†
                </h2>
                <div class="text-center py-12 text-gray-500">
                    <i class="fas fa-folder-open text-4xl mb-4"></i>
                    <p>æŠ•èµ„ç»„åˆç®¡ç†åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-16">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2024 Stock AI Advisor. AIé©±åŠ¨çš„ä¸“ä¸šæŠ•èµ„å†³ç­–å¹³å°</p>
        </div>
    </footer>

    <script>
        let chart = null;
        let currentTicker = '';

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from all tabs
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('tab-active', 'text-blue-600');
                    b.classList.add('text-gray-600');
                });
                
                // Add active class to clicked tab
                this.classList.add('tab-active', 'text-blue-600');
                this.classList.remove('text-gray-600');

                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });

                // Show corresponding tab content
                const tabId = this.id.replace('tab', '').toLowerCase() + 'Tab';
                document.getElementById(tabId).classList.remove('hidden');
            });
        });

        // Load market data on page load
        window.addEventListener('load', loadMarketData);

        async function loadMarketData() {
            try {
                const response = await fetch('/market');
                if (response.ok) {
                    const data = await response.json();
                    displayMarketData(data);
                }
            } catch (error) {
                console.error('åŠ è½½å¸‚åœºæ•°æ®å¤±è´¥:', error);
            } finally {
                document.getElementById('marketLoading').classList.add('hidden');
                document.getElementById('marketData').classList.remove('hidden');
            }
        }

        function displayMarketData(data) {
            // Display indices if available
            if (data.indices) {
                const indicesHtml = data.indices.map(index => `
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                        <h4 class="font-semibold">${index.name}</h4>
                        <p class="text-2xl font-bold ${index.change >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${index.price}
                        </p>
                        <p class="text-sm ${index.change >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${index.change >= 0 ? '+' : ''}${index.change} (${index.change_percent}%)
                        </p>
                    </div>
                `).join('');
                document.getElementById('indices').innerHTML = indicesHtml;
            }

            // Display top gainers and losers
            if (data.gainers) {
                const gainersHtml = data.gainers.map(stock => `
                    <li class="flex justify-between">
                        <span class="font-medium">${stock.symbol}</span>
                        <span class="text-green-600">+${stock.change}%</span>
                    </li>
                `).join('');
                document.getElementById('gainers').innerHTML = gainersHtml;
            }

            if (data.losers) {
                const losersHtml = data.losers.map(stock => `
                    <li class="flex justify-between">
                        <span class="font-medium">${stock.symbol}</span>
                        <span class="text-red-600">${stock.change}%</span>
                    </li>
                `).join('');
                document.getElementById('losers').innerHTML = losersHtml;
            }
        }

        // Stock search functionality
        document.getElementById('searchBtn').addEventListener('click', searchStock);
        document.getElementById('ticker').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStock();
            }
        });

        // Period selector
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.period-btn').forEach(b => {
                    b.classList.remove('bg-blue-500', 'text-white');
                    b.classList.add('border-gray-300');
                });
                this.classList.add('bg-blue-500', 'text-white');
                this.classList.remove('border-gray-300');
                
                if (currentTicker) {
                    searchStock(this.dataset.period);
                }
            });
        });

        async function searchStock(period = '1mo') {
            const ticker = document.getElementById('ticker').value.trim().toUpperCase();
            if (!ticker) {
                showError('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            currentTicker = ticker;
            showLoading();
            hideError();

            try {
                const response = await fetch(`/stock/${ticker}?period=${period}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'è·å–è‚¡ç¥¨æ•°æ®å¤±è´¥');
                }

                displayStockData(data);
                document.getElementById('periodSelector').classList.remove('hidden');
            } catch (error) {
                showError(`æŸ¥è¯¢å¤±è´¥: ${error.message}`);
                console.error('è‚¡ç¥¨æŸ¥è¯¢å¤±è´¥:', error);
            } finally {
                hideLoading();
            }
        }

        function displayStockData(data) {
            document.getElementById('result').classList.remove('hidden');
            
            // Set badge color based on decision
            const badge = document.getElementById('badge');
            badge.textContent = data.decision;
            if (data.decision === 'BUY') {
                badge.className = 'px-4 py-2 rounded-lg text-white text-lg font-bold bg-green-500';
            } else if (data.decision === 'SELL') {
                badge.className = 'px-4 py-2 rounded-lg text-white text-lg font-bold bg-red-500';
            } else {
                badge.className = 'px-4 py-2 rounded-lg text-white text-lg font-bold bg-yellow-500';
            }

            document.getElementById('tickerLabel').textContent = data.ticker;
            document.getElementById('price').textContent = `$${data.current_price}`;
            document.getElementById('open').textContent = `$${data.open}`;
            document.getElementById('high').textContent = `$${data.high}`;
            document.getElementById('low').textContent = `$${data.low}`;
            document.getElementById('volume').textContent = data.volume.toLocaleString();

            // Display reasons
            const reasonsList = document.getElementById('reasonsList');
            reasonsList.innerHTML = data.reasons.map(reason => 
                `<li class="flex items-start"><i class="fas fa-check text-blue-600 mt-1 mr-2"></i>${reason}</li>`
            ).join('');

            // Draw chart
            drawChart(data.history);
        }

        function drawChart(history) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            const labels = history.map(item => item.date);
            const prices = history.map(item => item.close);

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ”¶ç›˜ä»·',
                        data: prices,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function showLoading() {
            document.getElementById('searchLoading').classList.remove('hidden');
            document.getElementById('result').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('searchLoading').classList.add('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            errorDiv.classList.add('error-shake');
            
            setTimeout(() => {
                errorDiv.classList.remove('error-shake');
            }, 500);
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Fundamental Analysis Functions
        document.getElementById('fundamentalSearchBtn').addEventListener('click', analyzeFundamental);
        document.getElementById('fundamentalTicker').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeFundamental();
            }
        });

        async function analyzeFundamental() {
            const ticker = document.getElementById('fundamentalTicker').value.trim().toUpperCase();
            if (!ticker) {
                showFundamentalError('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            showFundamentalLoading();
            hideFundamentalError();

            try {
                // Get financial metrics
                const response = await fetch(`/fundamental/${ticker}`);
                const healthResponse = await fetch(`/fundamental/${ticker}/health`);
                
                if (!response.ok || !healthResponse.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'è·å–åŸºæœ¬é¢æ•°æ®å¤±è´¥');
                }

                const metrics = await response.json();
                const health = await healthResponse.json();

                displayFundamentalData(metrics, health);
            } catch (error) {
                showFundamentalError(`åˆ†æå¤±è´¥: ${error.message}`);
                console.error('åŸºæœ¬é¢åˆ†æå¤±è´¥:', error);
            } finally {
                hideFundamentalLoading();
            }
        }

        function displayFundamentalData(metrics, health) {
            document.getElementById('fundamentalResults').classList.remove('hidden');

            // Company Info
            document.getElementById('companyName').textContent = metrics.company_name || metrics.ticker;
            document.getElementById('companySector').textContent = `${metrics.sector} - ${metrics.industry}`;
            document.getElementById('marketCap').textContent = metrics.market_cap ? 
                `$${(metrics.market_cap / 1e9).toFixed(1)}B` : 'N/A';
            document.getElementById('peRatio').textContent = metrics.pe_ratio ? 
                metrics.pe_ratio.toFixed(1) : 'N/A';
            document.getElementById('pbRatio').textContent = metrics.pb_ratio ? 
                metrics.pb_ratio.toFixed(1) : 'N/A';

            // Health Scores
            document.getElementById('overallScore').textContent = health.overall_score.toFixed(1);
            document.getElementById('profitabilityScore').textContent = health.profitability_score.toFixed(1);
            document.getElementById('liquidityScore').textContent = health.liquidity_score.toFixed(1);
            document.getElementById('leverageScore').textContent = health.leverage_score.toFixed(1);
            document.getElementById('efficiencyScore').textContent = health.efficiency_score.toFixed(1);
            document.getElementById('growthScore').textContent = health.growth_score.toFixed(1);

            // Strengths and Weaknesses
            document.getElementById('strengthsList').innerHTML = health.strengths.map(s => 
                `<li class="flex items-start"><i class="fas fa-check text-green-600 mt-1 mr-2"></i>${s}</li>`
            ).join('');
            
            document.getElementById('weaknessesList').innerHTML = health.weaknesses.map(w => 
                `<li class="flex items-start"><i class="fas fa-times text-red-600 mt-1 mr-2"></i>${w}</li>`
            ).join('');
        }

        function showFundamentalLoading() {
            document.getElementById('fundamentalLoading').classList.remove('hidden');
            document.getElementById('fundamentalResults').classList.add('hidden');
        }

        function hideFundamentalLoading() {
            document.getElementById('fundamentalLoading').classList.add('hidden');
        }

        function showFundamentalError(message) {
            const errorDiv = document.getElementById('fundamentalError');
            const errorText = document.getElementById('fundamentalErrorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideFundamentalError() {
            document.getElementById('fundamentalError').classList.add('hidden');
        }

        // Risk Management Functions
        document.getElementById('riskAnalyzeBtn').addEventListener('click', analyzeRisk);
        document.getElementById('riskTicker').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeRisk();
            }
        });

        async function analyzeRisk() {
            const ticker = document.getElementById('riskTicker').value.trim().toUpperCase();
            if (!ticker) {
                showRiskError('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            showRiskLoading();
            hideRiskError();

            try {
                // Get comprehensive risk analysis
                const response = await fetch(`/risk/${ticker}/comprehensive`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'è·å–é£é™©æ•°æ®å¤±è´¥');
                }

                const risk = await response.json();
                displayRiskData(risk);
            } catch (error) {
                showRiskError(`é£é™©åˆ†æå¤±è´¥: ${error.message}`);
                console.error('é£é™©åˆ†æå¤±è´¥:', error);
            } finally {
                hideRiskLoading();
            }
        }

        function displayRiskData(risk) {
            document.getElementById('riskResults').classList.remove('hidden');

            // Risk Overview
            document.getElementById('riskLevel').textContent = risk.overall_risk_level;
            document.getElementById('riskLevel').className = `text-3xl font-bold mb-2 ${getRiskColor(risk.overall_risk_level)}`;
            document.getElementById('riskScore').textContent = `${risk.risk_score.toFixed(1)}/100`;
            
            // VaR Analysis
            if (risk.var_analysis) {
                document.getElementById('var95').textContent = risk.var_analysis.historical_var ? 
                    `${risk.var_analysis.historical_var.toFixed(2)}%` : 'N/A';
                document.getElementById('worstDay').textContent = risk.var_analysis.worst_day_loss ? 
                    `${risk.var_analysis.worst_day_loss.toFixed(2)}%` : 'N/A';
            }

            // Drawdown Analysis
            if (risk.drawdown_analysis) {
                document.getElementById('maxDrawdown').textContent = risk.drawdown_analysis.max_drawdown ? 
                    `${risk.drawdown_analysis.max_drawdown.toFixed(2)}%` : 'N/A';
                document.getElementById('currentDrawdown').textContent = risk.drawdown_analysis.current_drawdown ? 
                    `${risk.drawdown_analysis.current_drawdown.toFixed(2)}%` : 'N/A';
                document.getElementById('recoveryTime').textContent = risk.drawdown_analysis.recovery_time_avg ? 
                    `${risk.drawdown_analysis.recovery_time_avg.toFixed(0)}å¤©` : 'N/A';
            }

            // Volatility
            if (risk.volatility_analysis) {
                document.getElementById('volatility').textContent = risk.volatility_analysis.annualized_volatility ? 
                    `${risk.volatility_analysis.annualized_volatility.toFixed(1)}%` : 'N/A';
            }

            // Position Sizing
            if (risk.position_sizing) {
                document.getElementById('conservativePosition').textContent = risk.position_sizing.conservative_position ? 
                    `${risk.position_sizing.conservative_position.toFixed(1)}%` : 'N/A';
                document.getElementById('recommendedPosition').textContent = risk.position_sizing.recommended_position ? 
                    `${risk.position_sizing.recommended_position.toFixed(1)}%` : 'N/A';
                document.getElementById('aggressivePosition').textContent = risk.position_sizing.aggressive_position ? 
                    `${risk.position_sizing.aggressive_position.toFixed(1)}%` : 'N/A';
                document.getElementById('kellyPosition').textContent = risk.position_sizing.kelly_percentage ? 
                    `${risk.position_sizing.kelly_percentage.toFixed(1)}%` : 'N/A';
            }

            // Risk Warnings
            const warnings = risk.risk_mitigation_suggestions || [];
            document.getElementById('riskWarningsList').innerHTML = warnings.map(w => 
                `<li class="flex items-start"><i class="fas fa-exclamation-triangle text-yellow-600 mt-1 mr-2"></i>${w}</li>`
            ).join('');
        }

        function getRiskColor(riskLevel) {
            switch(riskLevel) {
                case 'LOW': return 'text-green-600';
                case 'MEDIUM': return 'text-yellow-600';
                case 'HIGH': return 'text-orange-600';
                case 'EXTREME': return 'text-red-600';
                default: return 'text-gray-600';
            }
        }

        function showRiskLoading() {
            document.getElementById('riskLoading').classList.remove('hidden');
            document.getElementById('riskResults').classList.add('hidden');
        }

        function hideRiskLoading() {
            document.getElementById('riskLoading').classList.add('hidden');
        }

        function showRiskError(message) {
            const errorDiv = document.getElementById('riskError');
            const errorText = document.getElementById('riskErrorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideRiskError() {
            document.getElementById('riskError').classList.add('hidden');
        }
    </script>
</body>
</html>