<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stock AI Advisor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4C+X2XlM0dX3Lg2fzjGZm4G6dkcnnr5lTyTX0bY4Z1cdq9VHtV6nRvWmvMRG4E9zMDswg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-4 max-w-xl">
    <h1 class="text-3xl font-bold text-center mb-6">📈 股票智能顾问</h1>
    <div class="bg-white shadow rounded p-6">
      <label for="ticker" class="block text-sm font-medium text-gray-700 mb-2">输入股票代码（美股如 AAPL，港股如 00700.HK）</label>
      <div class="flex gap-2">
        <input id="ticker" type="text" placeholder="AAPL" class="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <button id="searchBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Search</button>
      </div>
      <div id="result" class="mt-6 hidden">
        <div class="flex items-center gap-3 mb-4">
          <div id="badge" class="px-3 py-1 rounded text-white text-lg font-semibold"></div>
          <h2 id="tickerLabel" class="text-2xl font-semibold"></h2>
        </div>
        <p id="reasonText" class="mb-2 text-gray-700 font-medium">决策解释：</p>
        <ul id="reasonsList" class="mb-4 list-disc pl-6 text-gray-600"></ul>

        <canvas id="priceChart" height="200"></canvas>

        <table class="w-full text-left border mt-6">
          <thead>
            <tr class="bg-gray-200">
              <th class="p-2">Metric</th>
              <th class="p-2">Value</th>
            </tr>
          </thead>
          <tbody>
            <tr><td class="border p-2">Current Price</td><td id="price" class="border p-2"></td></tr>
            <tr><td class="border p-2">Open</td><td id="open" class="border p-2"></td></tr>
            <tr><td class="border p-2">High</td><td id="high" class="border p-2"></td></tr>
            <tr><td class="border p-2">Low</td><td id="low" class="border p-2"></td></tr>
            <tr><td class="border p-2">Volume</td><td id="volume" class="border p-2"></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const apiBase = "/stock/";
    const searchBtn = document.getElementById("searchBtn");
    const tickerInput = document.getElementById("ticker");
    const resultDiv = document.getElementById("result");
    const tickerLabel = document.getElementById("tickerLabel");
    const reasonText = document.getElementById("reasonText");
    const decisionIcon = document.getElementById("decisionIcon");

    function setBadge(decision) {
      const badge = document.getElementById("badge");
      if (decision === "BUY") {
        badge.textContent = "买入";
        badge.className = "px-3 py-1 rounded text-white text-lg font-semibold bg-green-600";
      } else if (decision === "SELL") {
        badge.textContent = "卖出";
        badge.className = "px-3 py-1 rounded text-white text-lg font-semibold bg-red-600";
      } else {
        badge.textContent = "持有";
        badge.className = "px-3 py-1 rounded text-white text-lg font-semibold bg-gray-500";
      }
    }

    let chart;

    searchBtn.addEventListener("click", () => {
      const ticker = tickerInput.value.trim().toUpperCase();
      if (!ticker) return;
      fetch(apiBase + ticker)
        .then((res) => {
          if (!res.ok) throw new Error("Ticker not found");
          return res.json();
        })
        .then((data) => {
          tickerLabel.textContent = data.ticker;
          reasonText.textContent = "Explanation:";
          const list = document.getElementById("reasonsList");
          list.innerHTML = "";
          const reasonsArr = data.reasons || (data.reason ? [data.reason] : []);
          reasonsArr.forEach(r => {
            const li = document.createElement("li");
            li.textContent = r;
            list.appendChild(li);
          });
          document.getElementById("price").textContent = data.current_price;
          document.getElementById("open").textContent = data.open;
          document.getElementById("high").textContent = data.high;
          document.getElementById("low").textContent = data.low;
          document.getElementById("volume").textContent = data.volume.toLocaleString();
          setBadge(data.decision);

          // Chart
          const labels = data.history.map(p => p.date);
          const prices = data.history.map(p => p.close);
          const ctx = document.getElementById("priceChart").getContext("2d");
          if (chart) chart.destroy();
          chart = new Chart(ctx, {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "收盘价",
                  data: prices,
                  borderColor: "#3b82f6",
                  backgroundColor: "rgba(59,130,246,0.1)",
                  tension: 0.2,
                },
              ],
            },
            options: {
              scales: {
                x: { display: false },
                y: { beginAtZero: false },
              },
              plugins: { legend: { display: false } },
            },
          });
          resultDiv.classList.remove("hidden");
        })
        .catch((err) => {
          alert(err.message);
          resultDiv.classList.add("hidden");
        });
    });

    // Press Enter to search
    tickerInput.addEventListener("keyup", (e) => {
      if (e.key === "Enter") searchBtn.click();
    });
  </script>
</body>
</html> 