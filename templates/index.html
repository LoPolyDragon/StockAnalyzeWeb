<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock AI Advisor - ä¸“ä¸šçº§è‚¡ç¥¨æŠ•èµ„AIåŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js æ ¸å¿ƒåº“ (ç”¨äºçº¿å›¾) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- TradingView Lightweight Charts (ç”¨äºKçº¿å›¾) -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <!-- ç”¨æˆ·è®¤è¯è„šæœ¬ -->
    <script>
        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        function checkAuthStatus() {
            const token = localStorage.getItem('access_token');
            const userInfo = localStorage.getItem('user_info');
            
            if (token && userInfo) {
                const user = JSON.parse(userInfo);
                showUserInfo(user);
                loadUserData();
            } else {
                showLoginButton();
            }
        }
        
        function showUserInfo(user) {
            const authContainer = document.getElementById('authContainer');
            if (authContainer) {
                authContainer.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            ${user.avatar_url ? 
                                `<img src="${user.avatar_url}" alt="å¤´åƒ" class="w-8 h-8 rounded-full">` : 
                                `<div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-medium">
                                    ${user.full_name ? user.full_name.charAt(0) : user.email.charAt(0)}
                                </div>`
                            }
                            <span class="text-gray-700 font-medium">${user.full_name || user.email}</span>
                        </div>
                        <button onclick="logout()" class="text-gray-500 hover:text-gray-700 transition-colors">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                `;
            }
        }
        
        function showLoginButton() {
            const authContainer = document.getElementById('authContainer');
            if (authContainer) {
                authContainer.innerHTML = `
                    <a href="/auth.html" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sign-in-alt mr-2"></i>ç™»å½•
                    </a>
                `;
            }
        }
        
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_info');
            window.location.reload();
        }
        
        async function loadUserData() {
            const token = localStorage.getItem('access_token');
            if (!token) return;
            
            try {
                // åŠ è½½ç”¨æˆ·å…³æ³¨åˆ—è¡¨
                const watchlistResponse = await fetch('/auth/watchlists', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (watchlistResponse.ok) {
                    const watchlists = await watchlistResponse.json();
                    updateWatchlistUI(watchlists);
                }
                
                // åŠ è½½ç”¨æˆ·æŠ•èµ„ç»„åˆ
                const portfolioResponse = await fetch('/auth/portfolios', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (portfolioResponse.ok) {
                    const portfolios = await portfolioResponse.json();
                    updatePortfolioUI(portfolios);
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
            }
        }
        
        function updateWatchlistUI(watchlists) {
            // å¦‚æœæœ‰ç”¨æˆ·å…³æ³¨åˆ—è¡¨ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ›´æ–°UI
            console.log('ç”¨æˆ·å…³æ³¨åˆ—è¡¨:', watchlists);
        }
        
        function updatePortfolioUI(portfolios) {
            // å¦‚æœæœ‰ç”¨æˆ·æŠ•èµ„ç»„åˆï¼Œå¯ä»¥åœ¨è¿™é‡Œæ›´æ–°UI
            console.log('ç”¨æˆ·æŠ•èµ„ç»„åˆ:', portfolios);
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            initPortfolioViewToggle();
        });
    </script>

    <script>
        // ç¡®ä¿è„šæœ¬æ­£ç¡®åŠ è½½
        window.addEventListener('load', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥å›¾è¡¨åº“');
            
            // æ£€æŸ¥Chart.jsæ˜¯å¦åŠ è½½
            if (typeof Chart === 'undefined') {
                console.error('Chart.jsæœªåŠ è½½ï¼Œå°è¯•é‡æ–°åŠ è½½');
                const chartScript = document.createElement('script');
                chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
                document.head.appendChild(chartScript);
            } else {
                console.log('Chart.jså·²åŠ è½½');
            }
            
            // æ£€æŸ¥TradingView Lightweight Chartsæ˜¯å¦åŠ è½½
            if (typeof LightweightCharts === 'undefined') {
                console.error('TradingViewå›¾è¡¨åº“æœªåŠ è½½ï¼Œå°è¯•é‡æ–°åŠ è½½');
                const tvScript = document.createElement('script');
                tvScript.src = 'https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js';
                document.head.appendChild(tvScript);
            } else {
                console.log('TradingViewå›¾è¡¨åº“å·²åŠ è½½');
            }
        });
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .error-shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .news-tab-btn {
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .news-tab-btn.active {
            border-bottom-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-chart-line text-2xl"></i>
                    <h1 class="text-2xl font-bold">Stock AI Advisor</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm opacity-90">ä¸“ä¸šçº§è‚¡ç¥¨æŠ•èµ„AIåŠ©æ‰‹</span>
                    <div id="authContainer">
                        <!-- è®¤è¯çŠ¶æ€å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    <i class="fas fa-robot text-xl"></i>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Navigation Tabs -->
        <div class="bg-white shadow rounded-lg mb-8">
            <nav class="flex border-b">
                <button id="tabDashboard" class="tab-btn px-6 py-4 font-semibold text-blue-600 tab-active">
                    <i class="fas fa-tachometer-alt mr-2"></i><span data-i18n="market_dashboard">å¸‚åœºä»ªè¡¨ç›˜</span>
                </button>
                <button id="tabStock" class="tab-btn px-6 py-4 font-semibold text-gray-600 hover:text-blue-600">
                    <i class="fas fa-chart-candlestick mr-2"></i><span data-i18n="stock_analysis">è‚¡ç¥¨åˆ†æ</span>
                </button>
                <button id="tabFundamental" class="tab-btn px-6 py-4 font-semibold text-gray-600 hover:text-blue-600">
                    <i class="fas fa-calculator mr-2"></i><span data-i18n="fundamental_analysis">åŸºæœ¬é¢åˆ†æ</span>
                </button>
                <button id="tabRisk" class="tab-btn px-6 py-4 font-semibold text-gray-600 hover:text-blue-600">
                    <i class="fas fa-shield-alt mr-2"></i><span data-i18n="risk_management">é£é™©ç®¡ç†</span>
                </button>
                <button id="tabPortfolio" class="tab-btn px-6 py-4 font-semibold text-gray-600 hover:text-blue-600">
                    <i class="fas fa-briefcase mr-2"></i><span data-i18n="portfolio">æŠ•èµ„ç»„åˆ</span>
                </button>
                <button id="tabTools" class="tab-btn px-6 py-4 font-semibold text-gray-600 hover:text-blue-600">
                    <i class="fas fa-calculator mr-2"></i><span data-i18n="investment_tools">æŠ•èµ„å·¥å…·</span>
                </button>
                <button id="tabSettings" class="tab-btn px-6 py-4 font-semibold text-gray-600 hover:text-blue-600">
                    <i class="fas fa-cog mr-2"></i><span data-i18n="settings">è®¾ç½®</span>
                </button>
            </nav>
        </div>

        <!-- Stock Search Section (Visible on Stock Analysis tabs) -->
        <div id="stockSearchSection" class="bg-white shadow rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-search mr-3 text-blue-600"></i>æ™ºèƒ½è‚¡ç¥¨åˆ†æ
            </h2>
            <div class="flex gap-3 mb-4">
                <input id="mainTicker" type="text" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚: AAPL, TSLA, MSFT)" 
                       class="flex-1 border-2 border-gray-300 rounded-lg px-4 py-3 text-lg focus:outline-none focus:border-blue-500 transition-colors">
                <button id="mainSearchBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-semibold transition-colors text-lg">
                    <i class="fas fa-search mr-2"></i>æ™ºèƒ½åˆ†æ
                </button>
            </div>
            
            <!-- Quick Stock Buttons -->
            <div class="flex flex-wrap gap-2">
                <span class="text-sm font-medium text-gray-700 self-center mr-2">çƒ­é—¨è‚¡ç¥¨:</span>
                <button class="quick-stock-btn px-3 py-1 rounded border border-gray-300 hover:bg-blue-100 text-sm" data-symbol="AAPL">AAPL</button>
                <button class="quick-stock-btn px-3 py-1 rounded border border-gray-300 hover:bg-blue-100 text-sm" data-symbol="TSLA">TSLA</button>
                <button class="quick-stock-btn px-3 py-1 rounded border border-gray-300 hover:bg-blue-100 text-sm" data-symbol="MSFT">MSFT</button>
                <button class="quick-stock-btn px-3 py-1 rounded border border-gray-300 hover:bg-blue-100 text-sm" data-symbol="GOOGL">GOOGL</button>
                <button class="quick-stock-btn px-3 py-1 rounded border border-gray-300 hover:bg-blue-100 text-sm" data-symbol="NVDA">NVDA</button>
                <button class="quick-stock-btn px-3 py-1 rounded border border-gray-300 hover:bg-blue-100 text-sm" data-symbol="META">META</button>
                <button class="quick-stock-btn px-3 py-1 rounded border border-gray-300 hover:bg-blue-100 text-sm" data-symbol="AMZN">AMZN</button>
            </div>
            
            <!-- Loading State -->
            <div id="mainSearchLoading" class="text-center py-8 hidden">
                <i class="fas fa-spinner loading text-2xl text-blue-600"></i>
                <p class="mt-2 text-gray-600">æ­£åœ¨è¿›è¡Œæ™ºèƒ½åˆ†æ...</p>
            </div>
        </div>

        <!-- Market Dashboard Tab -->
        <div id="dashboardTab" class="tab-content">
            <!-- Market Indices -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white shadow rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">S&P 500</h3>
                        <i class="fas fa-chart-line text-blue-600"></i>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <div id="spxPrice" class="text-2xl font-bold text-gray-900">4,320.45</div>
                            <div id="spxChange" class="text-sm text-green-600">+12.34 (+0.29%)</div>
                        </div>
                        <div class="w-16 h-12">
                            <canvas id="spxMiniChart" class="w-full h-full"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white shadow rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">NASDAQ</h3>
                        <i class="fas fa-microchip text-purple-600"></i>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <div id="nasdaqPrice" class="text-2xl font-bold text-gray-900">13,456.78</div>
                            <div id="nasdaqChange" class="text-sm text-red-600">-25.67 (-0.19%)</div>
                        </div>
                        <div class="w-16 h-12">
                            <canvas id="nasdaqMiniChart" class="w-full h-full"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white shadow rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">DOW</h3>
                        <i class="fas fa-industry text-green-600"></i>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <div id="dowPrice" class="text-2xl font-bold text-gray-900">34,567.89</div>
                            <div id="dowChange" class="text-sm text-green-600">+89.12 (+0.26%)</div>
                        </div>
                        <div class="w-16 h-12">
                            <canvas id="dowMiniChart" class="w-full h-full"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Market Heatmap and Stats -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Sector Heatmap -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-th mr-3 text-orange-600"></i>è¡Œä¸šçƒ­åŠ›å›¾
                    </h3>
                    <div id="sectorHeatmap" class="grid grid-cols-2 gap-2">
                        <!-- Sector boxes will be populated here -->
                    </div>
                </div>
                
                <!-- Market Sentiment -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-heart-pulse mr-3 text-red-600"></i>å¸‚åœºæƒ…ç»ª
                    </h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">ææƒ§è´ªå©ªæŒ‡æ•°</span>
                            <div class="flex items-center space-x-2">
                                <div class="w-24 bg-gray-200 rounded-full h-2">
                                    <div id="fearGreedBar" class="bg-green-500 h-2 rounded-full" style="width: 75%"></div>
                                </div>
                                <span id="fearGreedValue" class="text-sm font-medium">75 (è´ªå©ª)</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">VIX æ³¢åŠ¨ç‡</span>
                            <span id="vixValue" class="font-medium">18.45</span>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">ä¸Šæ¶¨è‚¡ç¥¨æ¯”ä¾‹</span>
                            <span id="advanceDecline" class="font-medium text-green-600">68%</span>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">æ–°é«˜/æ–°ä½æ¯”</span>
                            <span id="highLowRatio" class="font-medium">3.2</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Top Gainers and Losers -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Top Gainers -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-arrow-trend-up mr-3 text-green-600"></i>ä»Šæ—¥æ¶¨å¹…æ¦œ
                    </h3>
                    <div id="topGainers" class="space-y-3">
                        <!-- Top gainers will be populated here -->
                    </div>
                </div>
                
                <!-- Top Losers -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-arrow-trend-down mr-3 text-red-600"></i>ä»Šæ—¥è·Œå¹…æ¦œ
                    </h3>
                    <div id="topLosers" class="space-y-3">
                        <!-- Top losers will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Volume Leaders and News -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Volume Leaders -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-volume-high mr-3 text-blue-600"></i>æˆäº¤é‡æ’è¡Œ
                    </h3>
                    <div id="volumeLeaders" class="space-y-3">
                        <!-- Volume leaders will be populated here -->
                    </div>
                </div>
                
                <!-- Market News -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-newspaper mr-3 text-purple-600"></i>å¸‚åœºå¿«è®¯
                    </h3>
                    <div id="dashboardNews" class="space-y-3">
                        <!-- News will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock Analysis Tab -->
        <div id="stockTab" class="tab-content hidden">
            <!-- Stock Analysis Results -->
            <div id="stockAnalysisResults" class="hidden">
                <!-- Stock Result -->
                <div class="bg-white shadow rounded-lg p-6 mb-8">
                    <div class="flex items-center gap-4 mb-6">
                        <div id="badge" class="px-4 py-2 rounded-lg text-white text-lg font-bold"></div>
                        <div>
                            <h2 id="tickerLabel" class="text-2xl font-bold"></h2>
                            <p id="companyNameLabel" class="text-lg text-gray-700"></p>
                            <p id="priceInfo" class="text-gray-600"></p>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <h4 class="font-semibold mb-2 text-blue-800">AIå†³ç­–åˆ†æ</h4>
                        <ul id="reasonsList" class="space-y-1"></ul>
                    </div>

                    <!-- Period Selector -->
                    <div id="periodSelector" class="flex flex-wrap gap-2 mb-6">
                        <span class="text-sm font-medium text-gray-700 self-center mr-2">å›¾è¡¨ç±»å‹:</span>
                        <button class="chart-type-btn px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 text-sm bg-blue-500 text-white" data-type="line">çº¿å›¾</button>
                        <button class="chart-type-btn px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 text-sm" data-type="candlestick">Kçº¿å›¾</button>
                        
                        <span class="text-sm font-medium text-gray-700 self-center ml-4 mr-2">æ—¶é—´å‘¨æœŸ:</span>
                        <button class="period-btn px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 text-sm" data-period="1d">1æ—¥</button>
                        <button class="period-btn px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 text-sm" data-period="1wk">1å‘¨</button>
                        <button class="period-btn px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 text-sm" data-period="1mo">1æœˆ</button>
                        <button class="period-btn px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 text-sm bg-blue-500 text-white" data-period="3mo">3æœˆ</button>
                        <button class="period-btn px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 text-sm" data-period="6mo">6æœˆ</button>
                        <button class="period-btn px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 text-sm" data-period="1y">1å¹´</button>
                        <button class="period-btn px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 text-sm" data-period="2y">2å¹´</button>
                    </div>

                    <!-- å¢åŠ å›¾è¡¨é«˜åº¦ -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <h4 class="font-semibold mb-4 text-gray-800">ä»·æ ¼èµ°åŠ¿</h4>
                        <div id="chartContainer" style="height: 500px;">
                            <canvas id="priceChart"></canvas>
                            <div id="candlestickChart"></div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg">
                        <h4 class="font-semibold mb-4 text-gray-800">é‡è¦æé†’</h4>
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-yellow-700">
                                        <strong>æŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ã€‚</strong> æœ¬åˆ†æä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚è¯·ç»“åˆè‡ªèº«æƒ…å†µåšå‡ºæŠ•èµ„å†³ç­–ã€‚
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State for Stock Analysis -->
            <div id="stockAnalysisEmpty" class="bg-white shadow rounded-lg p-6">
                <div class="text-center py-12">
                    <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">è¿˜æ²¡æœ‰åˆ†æä»»ä½•è‚¡ç¥¨</h3>
                    <p class="text-gray-500 mb-6">è¯·ä½¿ç”¨é¡¶éƒ¨çš„æ™ºèƒ½è‚¡ç¥¨åˆ†æåŠŸèƒ½æ¥æŸ¥çœ‹è¯¦ç»†çš„è‚¡ç¥¨åˆ†ææŠ¥å‘Š</p>
                    <button onclick="focusMainSearch()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-arrow-up mr-2"></i>å»æœç´¢è‚¡ç¥¨
                    </button>
                </div>
            </div>
        </div>

        <!-- Fundamental Analysis Tab -->
        <div id="fundamentalTab" class="tab-content hidden">
            <!-- Fundamental Analysis Results -->
            <div id="fundamentalAnalysisResults" class="hidden">
                <div class="bg-white shadow rounded-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-calculator mr-3 text-blue-600"></i>åŸºæœ¬é¢åˆ†æ
                    </h2>

                    <!-- Loading State -->
                    <div id="fundamentalLoading" class="text-center py-8 hidden">
                        <i class="fas fa-spinner loading text-2xl text-green-600"></i>
                        <p class="mt-2 text-gray-600">æ­£åœ¨åˆ†æåŸºæœ¬é¢æ•°æ®...</p>
                    </div>

                    <!-- Results -->
                    <div id="fundamentalResult" class="hidden">
                    <!-- Company Info -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <h3 id="companyName" class="text-xl font-bold mb-2"></h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">è¡Œä¸š</p>
                                <p id="companySector" class="font-semibold"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">å¸‚å€¼</p>
                                <p id="marketCap" class="font-semibold"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">P/Eæ¯”ç‡</p>
                                <p id="peRatio" class="font-semibold"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">P/Bæ¯”ç‡</p>
                                <p id="pbRatio" class="font-semibold"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Health Score -->
                    <div class="bg-blue-50 p-6 rounded-lg mb-6">
                        <h4 class="text-lg font-bold mb-4 text-blue-800">è´¢åŠ¡å¥åº·åº¦è¯„åˆ†</h4>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <div id="overallScore" class="text-3xl font-bold text-blue-600 mb-1"></div>
                                <p class="text-sm text-gray-600">æ€»ä½“è¯„åˆ†</p>
                            </div>
                            <div class="text-center">
                                <div id="profitabilityScore" class="text-2xl font-bold text-green-600 mb-1"></div>
                                <p class="text-sm text-gray-600">ç›ˆåˆ©èƒ½åŠ›</p>
                            </div>
                            <div class="text-center">
                                <div id="liquidityScore" class="text-2xl font-bold text-yellow-600 mb-1"></div>
                                <p class="text-sm text-gray-600">æµåŠ¨æ€§</p>
                            </div>
                            <div class="text-center">
                                <div id="leverageScore" class="text-2xl font-bold text-purple-600 mb-1"></div>
                                <p class="text-sm text-gray-600">è´¢åŠ¡æ æ†</p>
                            </div>
                            <div class="text-center">
                                <div id="efficiencyScore" class="text-2xl font-bold text-indigo-600 mb-1"></div>
                                <p class="text-sm text-gray-600">è¿è¥æ•ˆç‡</p>
                            </div>
                            <div class="text-center">
                                <div id="growthScore" class="text-2xl font-bold text-pink-600 mb-1"></div>
                                <p class="text-sm text-gray-600">æˆé•¿æ€§</p>
                            </div>
                        </div>
                    </div>

                    <!-- Strengths and Weaknesses -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h5 class="font-bold text-green-800 mb-3">âœ… ä¼˜åŠ¿</h5>
                            <ul id="strengthsList" class="space-y-1 text-green-700"></ul>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h5 class="font-bold text-red-800 mb-3">âš ï¸ åŠ£åŠ¿</h5>
                            <ul id="weaknessesList" class="space-y-1 text-red-700"></ul>
                        </div>
                    </div>
                </div>

                    <!-- Error Message -->
                    <div id="fundamentalError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <span id="fundamentalErrorText"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State for Fundamental Analysis -->
            <div id="fundamentalAnalysisEmpty" class="bg-white shadow rounded-lg p-6">
                <div class="text-center py-12">
                    <i class="fas fa-calculator text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">åŸºæœ¬é¢åˆ†æéœ€è¦å…ˆé€‰æ‹©è‚¡ç¥¨</h3>
                    <p class="text-gray-500 mb-6">è¯·å…ˆä½¿ç”¨é¡¶éƒ¨çš„æ™ºèƒ½è‚¡ç¥¨åˆ†æåŠŸèƒ½ï¼ŒåŸºæœ¬é¢åˆ†æä¼šè‡ªåŠ¨æ˜¾ç¤º</p>
                    <button onclick="focusMainSearch()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-arrow-up mr-2"></i>å»åˆ†æè‚¡ç¥¨
                    </button>
                </div>
            </div>
        </div>

        <!-- Risk Management Tab -->
        <div id="riskTab" class="tab-content hidden">
            <!-- Risk Analysis Results -->
            <div id="riskAnalysisResults" class="hidden">
                <div class="bg-white shadow rounded-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-shield-alt mr-3 text-blue-600"></i>é£é™©ç®¡ç†
                    </h2>

                    <!-- Loading State -->
                    <div id="riskLoading" class="text-center py-8 hidden">
                        <i class="fas fa-spinner loading text-2xl text-red-600"></i>
                        <p class="mt-2 text-gray-600">æ­£åœ¨åˆ†æé£é™©æ•°æ®...</p>
                    </div>

                    <!-- Results -->
                    <div id="riskResult" class="hidden">
                    <!-- Risk Overview -->
                    <div class="bg-red-50 p-6 rounded-lg mb-6">
                        <h4 class="text-lg font-bold mb-4 text-red-800">é£é™©è¯„ä¼°æ¦‚è§ˆ</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="text-center">
                                <div id="riskLevel" class="text-3xl font-bold mb-2"></div>
                                <p class="text-sm text-gray-600">é£é™©ç­‰çº§</p>
                            </div>
                            <div class="text-center">
                                <div id="riskScore" class="text-3xl font-bold mb-2"></div>
                                <p class="text-sm text-gray-600">é£é™©è¯„åˆ†</p>
                            </div>
                            <div class="text-center">
                                <div id="volatility" class="text-3xl font-bold mb-2"></div>
                                <p class="text-sm text-gray-600">å¹´åŒ–æ³¢åŠ¨ç‡</p>
                            </div>
                        </div>
                    </div>

                    <!-- VaR Analysis -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h5 class="font-bold text-orange-800 mb-3">ğŸ“Š VaRé£é™©ä»·å€¼</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span>95%ç½®ä¿¡åº¦VaR:</span>
                                    <span id="var95" class="font-bold"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>99%ç½®ä¿¡åº¦VaR:</span>
                                    <span id="var99" class="font-bold"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>å†å²æœ€å¤§å•æ—¥è·Œå¹…:</span>
                                    <span id="worstDay" class="font-bold text-red-600"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h5 class="font-bold text-purple-800 mb-3">ğŸ“ˆ å›æ’¤åˆ†æ</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span>æœ€å¤§å›æ’¤:</span>
                                    <span id="maxDrawdown" class="font-bold text-red-600"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>å½“å‰å›æ’¤:</span>
                                    <span id="currentDrawdown" class="font-bold"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>å¹³å‡æ¢å¤æ—¶é—´:</span>
                                    <span id="recoveryTime" class="font-bold"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Position Sizing -->
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <h5 class="font-bold text-blue-800 mb-3">ğŸ’° ä»“ä½å»ºè®®</h5>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center">
                                <div id="conservativePosition" class="text-xl font-bold text-green-600"></div>
                                <p class="text-sm">ä¿å®ˆå»ºè®®</p>
                            </div>
                            <div class="text-center">
                                <div id="recommendedPosition" class="text-xl font-bold text-blue-600"></div>
                                <p class="text-sm">æ¨èå»ºè®®</p>
                            </div>
                            <div class="text-center">
                                <div id="aggressivePosition" class="text-xl font-bold text-orange-600"></div>
                                <p class="text-sm">æ¿€è¿›å»ºè®®</p>
                            </div>
                            <div class="text-center">
                                <div id="kellyPosition" class="text-xl font-bold text-purple-600"></div>
                                <p class="text-sm">å‡¯åˆ©å…¬å¼</p>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Warnings -->
                    <div id="riskWarnings" class="bg-yellow-50 p-4 rounded-lg">
                        <h5 class="font-bold text-yellow-800 mb-3">âš ï¸ é£é™©æç¤º</h5>
                        <ul id="riskWarningsList" class="space-y-1 text-yellow-700"></ul>
                    </div>
                </div>

                    <!-- Error Message -->
                    <div id="riskError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <span id="riskErrorText"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State for Risk Analysis -->
            <div id="riskAnalysisEmpty" class="bg-white shadow rounded-lg p-6">
                <div class="text-center py-12">
                    <i class="fas fa-shield-alt text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">é£é™©åˆ†æéœ€è¦å…ˆé€‰æ‹©è‚¡ç¥¨</h3>
                    <p class="text-gray-500 mb-6">è¯·å…ˆä½¿ç”¨é¡¶éƒ¨çš„æ™ºèƒ½è‚¡ç¥¨åˆ†æåŠŸèƒ½ï¼Œé£é™©ç®¡ç†ä¼šè‡ªåŠ¨æ˜¾ç¤º</p>
                    <button onclick="focusMainSearch()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-arrow-up mr-2"></i>å»åˆ†æè‚¡ç¥¨
                    </button>
                </div>
            </div>
        </div>

        <!-- Portfolio Tab -->
        <div id="portfolioTab" class="tab-content hidden">
            <!-- Portfolio Management Header -->
            <div class="bg-white shadow rounded-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold flex items-center">
                        <i class="fas fa-briefcase mr-3 text-blue-600"></i>æ™ºèƒ½æŠ•èµ„ç»„åˆç®¡ç†
                    </h2>
                    <div class="flex space-x-3">
                        <button id="createPortfolioBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            <i class="fas fa-plus mr-2"></i>æ‰‹åŠ¨ç»„åˆ
                        </button>
                        <button id="createAutoPortfolioBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            <i class="fas fa-robot mr-2"></i>AIè‡ªåŠ¨ç»„åˆ
                        </button>
                    </div>
                </div>
                
                <!-- Portfolio Type Filter -->
                <div class="flex flex-wrap gap-2">
                    <button class="portfolio-filter-btn px-3 py-1 rounded text-sm bg-blue-500 text-white" data-filter="all">
                        å…¨éƒ¨
                    </button>
                    <button class="portfolio-filter-btn px-3 py-1 rounded text-sm border hover:bg-gray-100" data-filter="manual">
                        æ‰‹åŠ¨ç®¡ç†
                    </button>
                    <button class="portfolio-filter-btn px-3 py-1 rounded text-sm border hover:bg-gray-100" data-filter="auto">
                        AIè‡ªåŠ¨
                    </button>
                    <button class="portfolio-filter-btn px-3 py-1 rounded text-sm border hover:bg-gray-100" data-filter="hybrid">
                        æ··åˆæ¨¡å¼
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="portfolioLoading" class="bg-white shadow rounded-lg p-6 text-center hidden">
                <i class="fas fa-spinner loading text-2xl text-blue-600"></i>
                <p class="mt-2 text-gray-600">æ­£åœ¨åŠ è½½æŠ•èµ„ç»„åˆ...</p>
            </div>

            <!-- Portfolio List -->
            <div id="portfolioList" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6"></div>

            <!-- Empty State -->
            <div id="portfolioEmpty" class="bg-white shadow rounded-lg p-6 text-center hidden">
                <i class="fas fa-briefcase text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">è¿˜æ²¡æœ‰æŠ•èµ„ç»„åˆ</h3>
                <p class="text-gray-500 mb-6">åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªæŠ•èµ„ç»„åˆï¼Œå¼€å§‹æ™ºèƒ½æŠ•èµ„ä¹‹æ—…</p>
                <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors" onclick="showCreatePortfolioModal()">
                    <i class="fas fa-plus mr-2"></i>åˆ›å»ºç¬¬ä¸€ä¸ªæŠ•èµ„ç»„åˆ
                </button>
            </div>

            <!-- Portfolio Details -->
            <div id="portfolioDetails" class="bg-white shadow rounded-lg p-6 hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <div class="flex items-center space-x-3">
                            <h3 id="portfolioDetailsName" class="text-xl font-bold"></h3>
                            <span id="portfolioModeIndicator" class="px-2 py-1 rounded text-xs font-medium"></span>
                            <span id="portfolioStatusIndicator" class="px-2 py-1 rounded text-xs font-medium"></span>
                        </div>
                        <p id="portfolioDetailsDesc" class="text-gray-600"></p>
                    </div>
                    <div class="flex space-x-2">
                        <button id="toggleModeBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg hidden">
                            <i class="fas fa-exchange-alt mr-2"></i>åˆ‡æ¢æ¨¡å¼
                        </button>
                        <button id="runAIAnalysisBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg hidden">
                            <i class="fas fa-brain mr-2"></i>AIåˆ†æ
                        </button>
                        <button id="executeAIBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg hidden">
                            <i class="fas fa-play mr-2"></i>æ‰§è¡ŒAIæ¨è
                        </button>
                        <button id="editPortfolioBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-edit mr-2"></i>ç¼–è¾‘
                        </button>
                        <button id="deletePortfolioBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-trash mr-2"></i>åˆ é™¤
                        </button>
                        <button id="addHoldingBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-plus mr-2"></i>æ·»åŠ æŒä»“
                        </button>
                        <button id="backToListBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-arrow-left mr-2"></i>è¿”å›åˆ—è¡¨
                        </button>
                    </div>
                </div>
                
                <!-- Auto Trading Status (for automated portfolios) -->
                <div id="autoTradingStatus" class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg mb-6 hidden">
                    <h4 class="font-bold text-indigo-800 mb-3 flex items-center">
                        <i class="fas fa-robot mr-2"></i>AIè‡ªåŠ¨äº¤æ˜“çŠ¶æ€
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <p class="text-gray-600">AIåˆ†æçŠ¶æ€</p>
                            <p id="aiAnalysisStatus" class="font-medium"></p>
                        </div>
                        <div>
                            <p class="text-gray-600">ä»Šæ—¥äº¤æ˜“æ¬¡æ•°</p>
                            <p id="dailyTradesCount" class="font-medium"></p>
                        </div>
                        <div>
                            <p class="text-gray-600">ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´</p>
                            <p id="nextExecutionTime" class="font-medium"></p>
                        </div>
                        <div>
                            <p class="text-gray-600">å¯ç”¨èµ„é‡‘</p>
                            <p id="availableCash" class="font-medium text-green-600"></p>
                        </div>
                    </div>
                </div>
                
                <!-- AI Recommendations -->
                <div id="aiRecommendations" class="bg-green-50 p-4 rounded-lg mb-6 hidden">
                    <h4 class="font-bold text-green-800 mb-3 flex items-center">
                        <i class="fas fa-lightbulb mr-2"></i>AIè‚¡ç¥¨æ¨è
                        <span id="recommendationCount" class="ml-2 px-2 py-1 bg-green-200 text-green-800 text-xs rounded-full"></span>
                    </h4>
                    <div id="recommendationsList" class="space-y-3"></div>
                    <div class="mt-4 text-center">
                        <button id="refreshRecommendationsBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
                            <i class="fas fa-refresh mr-2"></i>åˆ·æ–°æ¨è
                        </button>
                    </div>
                </div>

                <!-- Portfolio Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white shadow rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">æ€»å¸‚å€¼</h3>
                            <i class="fas fa-wallet text-blue-600"></i>
                        </div>
                        <div id="portfolioTotalValue" class="text-2xl font-bold text-gray-900">$0.00</div>
                        <div class="text-sm text-gray-600 mt-1">æŠ•èµ„ç»„åˆä»·å€¼</div>
                    </div>
                    
                    <div class="bg-white shadow rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">æ€»ç›ˆäº</h3>
                            <i class="fas fa-chart-line text-green-600"></i>
                        </div>
                        <div id="portfolioTotalPnL" class="text-2xl font-bold">$0.00</div>
                        <div class="text-sm text-gray-600 mt-1">ç»å¯¹æ”¶ç›Š</div>
                    </div>
                    
                    <div class="bg-white shadow rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">ç›ˆäºç‡</h3>
                            <i class="fas fa-percentage text-purple-600"></i>
                        </div>
                        <div id="portfolioTotalPnLPct" class="text-2xl font-bold">0.00%</div>
                        <div class="text-sm text-gray-600 mt-1">æ”¶ç›Šç‡</div>
                    </div>
                    
                    <div class="bg-white shadow rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">æŒä»“æ•°é‡</h3>
                            <i class="fas fa-building text-yellow-600"></i>
                        </div>
                        <div id="portfolioHoldingsCount" class="text-2xl font-bold text-gray-900">0</div>
                        <div class="text-sm text-gray-600 mt-1">è‚¡ç¥¨æ•°é‡</div>
                    </div>
                </div>

                <!-- Holdings List -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-chart-pie mr-3 text-purple-600"></i>æŒä»“æ˜ç»†
                    </h3>
                    
                    <!-- Holdings Cards -->
                    <div id="holdingsContainer" class="space-y-4">
                        <!-- Holdings will be populated here as cards -->
                    </div>
                    
                    <!-- Holdings Table (fallback for complex view) -->
                    <div id="holdingsTableView" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse bg-white">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="border border-gray-200 p-3 text-left text-sm font-medium text-gray-700">è‚¡ç¥¨ä»£ç </th>
                                        <th class="border border-gray-200 p-3 text-right text-sm font-medium text-gray-700">æŒä»“æ•°é‡</th>
                                        <th class="border border-gray-200 p-3 text-right text-sm font-medium text-gray-700">æˆæœ¬ä»·</th>
                                        <th class="border border-gray-200 p-3 text-right text-sm font-medium text-gray-700">å½“å‰ä»·</th>
                                        <th class="border border-gray-200 p-3 text-right text-sm font-medium text-gray-700">å¸‚å€¼</th>
                                        <th class="border border-gray-200 p-3 text-right text-sm font-medium text-gray-700">ç›ˆäº</th>
                                        <th class="border border-gray-200 p-3 text-right text-sm font-medium text-gray-700">ç›ˆäºç‡</th>
                                        <th class="border border-gray-200 p-3 text-right text-sm font-medium text-gray-700">æƒé‡</th>
                                        <th class="border border-gray-200 p-3 text-center text-sm font-medium text-gray-700">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="holdingsTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- View Toggle -->
                    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
                        <div class="flex space-x-2">
                            <button id="cardViewBtn" class="px-3 py-1 rounded text-sm bg-blue-500 text-white">
                                <i class="fas fa-th-large mr-1"></i>å¡ç‰‡è§†å›¾
                            </button>
                            <button id="tableViewBtn" class="px-3 py-1 rounded text-sm border hover:bg-gray-100">
                                <i class="fas fa-table mr-1"></i>è¡¨æ ¼è§†å›¾
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Empty Holdings -->
                <div id="holdingsEmpty" class="bg-white shadow rounded-lg p-6 text-center hidden">
                    <i class="fas fa-chart-line text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">æš‚æ— æŒä»“</h3>
                    <p class="text-gray-500 mb-6">æ­¤æŠ•èµ„ç»„åˆè¿˜æ²¡æœ‰ä»»ä½•è‚¡ç¥¨æŒä»“</p>
                    <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors" onclick="showAddHoldingModal()">
                        <i class="fas fa-plus mr-2"></i>æ·»åŠ ç¬¬ä¸€ä¸ªæŒä»“
                    </button>
                </div>
            </div>
        </div>

        <!-- Create Portfolio Modal -->
        <div id="createPortfolioModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <h3 class="text-lg font-bold mb-4">åˆ›å»ºæ–°æŠ•èµ„ç»„åˆ</h3>
                <form id="createPortfolioForm">
                    <div class="mb-4">
                        <label for="portfolioName" class="block text-sm font-medium text-gray-700 mb-2">ç»„åˆåç§°</label>
                        <input type="text" id="portfolioName" name="name" required 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="portfolioDescription" class="block text-sm font-medium text-gray-700 mb-2">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                        <textarea id="portfolioDescription" name="description" rows="3"
                                  class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideCreatePortfolioModal()" 
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            åˆ›å»º
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Holding Modal -->
        <div id="addHoldingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <h3 class="text-lg font-bold mb-4">æ·»åŠ æŒä»“</h3>
                <form id="addHoldingForm">
                    <div class="mb-4">
                        <label for="holdingTicker" class="block text-sm font-medium text-gray-700 mb-2">è‚¡ç¥¨ä»£ç </label>
                        <input type="text" id="holdingTicker" name="ticker" required placeholder="å¦‚: AAPL, 00700.HK"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="holdingShares" class="block text-sm font-medium text-gray-700 mb-2">æŒä»“æ•°é‡</label>
                        <input type="number" id="holdingShares" name="shares" required step="0.01" min="0.01"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="holdingCost" class="block text-sm font-medium text-gray-700 mb-2">æˆæœ¬ä»·ï¼ˆæ¯è‚¡ï¼‰</label>
                        <input type="number" id="holdingCost" name="cost_per_share" required step="0.01" min="0.01"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideAddHoldingModal()" 
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            æ·»åŠ 
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Create Automated Portfolio Modal -->
        <div id="createAutoPortfolioModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-robot mr-2 text-green-600"></i>åˆ›å»ºAIè‡ªåŠ¨æŠ•èµ„ç»„åˆ
                </h3>
                <form id="createAutoPortfolioForm">
                    <!-- Basic Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="autoPortfolioName" class="block text-sm font-medium text-gray-700 mb-2">ç»„åˆåç§°</label>
                            <input type="text" id="autoPortfolioName" name="name" required 
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label for="autoPortfolioMode" class="block text-sm font-medium text-gray-700 mb-2">æŠ•èµ„æ¨¡å¼</label>
                            <select id="autoPortfolioMode" name="mode" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                                <option value="auto">å®Œå…¨è‡ªåŠ¨</option>
                                <option value="hybrid">æ··åˆæ¨¡å¼</option>
                                <option value="manual">æ‰‹åŠ¨ç®¡ç†</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="autoPortfolioDescription" class="block text-sm font-medium text-gray-700 mb-2">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                        <textarea id="autoPortfolioDescription" name="description" rows="2"
                                  class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500"></textarea>
                    </div>

                    <!-- Budget Configuration -->
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-dollar-sign mr-2 text-green-600"></i>èµ„é‡‘é…ç½®
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="totalBudget" class="block text-sm font-medium text-gray-700 mb-2">æ€»é¢„ç®— (USD)</label>
                            <input type="number" id="totalBudget" name="total_budget" required min="1000" step="100" 
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label for="maxSinglePosition" class="block text-sm font-medium text-gray-700 mb-2">å•è‚¡æœ€å¤§æŠ•èµ„é¢ (USD)</label>
                            <input type="number" id="maxSinglePosition" name="max_single_position" required min="100" step="50" 
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                        </div>
                    </div>

                    <!-- Trading API Configuration -->
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-link mr-2 text-blue-600"></i>äº¤æ˜“APIé…ç½®
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="apiProvider" class="block text-sm font-medium text-gray-700 mb-2">APIæä¾›å•†</label>
                            <select id="apiProvider" name="api_provider" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                                <option value="paper_trading">çº¸ä¸Šäº¤æ˜“ (æ¨¡æ‹Ÿ)</option>
                                <option value="alpaca">Alpaca</option>
                                <option value="interactive_brokers">Interactive Brokers</option>
                                <option value="td_ameritrade">TD Ameritrade</option>
                                <option value="schwab">Charles Schwab</option>
                            </select>
                        </div>
                        <div>
                            <label class="flex items-center space-x-2 text-sm">
                                <input type="checkbox" id="isSandbox" name="is_sandbox" checked class="rounded">
                                <span>æ²™ç›’/æ¨¡æ‹Ÿç¯å¢ƒ</span>
                            </label>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                            <input type="text" id="apiKey" name="api_key" 
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label for="apiSecret" class="block text-sm font-medium text-gray-700 mb-2">API Secret</label>
                            <input type="password" id="apiSecret" name="api_secret" 
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                        </div>
                    </div>

                    <!-- AI Strategy Configuration -->
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-brain mr-2 text-purple-600"></i>AIç­–ç•¥é…ç½®
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="riskTolerance" class="block text-sm font-medium text-gray-700 mb-2">é£é™©æ‰¿å—åº¦</label>
                            <select id="riskTolerance" name="risk_tolerance" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                                <option value="conservative">ä¿å®ˆå‹</option>
                                <option value="moderate" selected>ç¨³å¥å‹</option>
                                <option value="aggressive">æ¿€è¿›å‹</option>
                            </select>
                        </div>
                        <div>
                            <label for="maxDailyTrades" class="block text-sm font-medium text-gray-700 mb-2">æ¯æ—¥æœ€å¤§äº¤æ˜“æ¬¡æ•°</label>
                            <input type="number" id="maxDailyTrades" name="max_daily_trades" value="5" min="1" max="20" 
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label for="rebalanceFreq" class="block text-sm font-medium text-gray-700 mb-2">é‡æ–°å¹³è¡¡é¢‘ç‡</label>
                            <select id="rebalanceFreq" name="rebalance_frequency" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                                <option value="daily" selected>æ¯æ—¥</option>
                                <option value="weekly">æ¯å‘¨</option>
                                <option value="monthly">æ¯æœˆ</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="stopLossPct" class="block text-sm font-medium text-gray-700 mb-2">æ­¢æŸæ¯”ä¾‹ (%)</label>
                            <input type="number" id="stopLossPct" name="stop_loss_pct" value="10" min="1" max="50" step="0.5"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label for="takeProfitPct" class="block text-sm font-medium text-gray-700 mb-2">æ­¢ç›ˆæ¯”ä¾‹ (%)</label>
                            <input type="number" id="takeProfitPct" name="take_profit_pct" value="20" min="5" max="100" step="0.5"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideCreateAutoPortfolioModal()" 
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i class="fas fa-robot mr-2"></i>åˆ›å»ºAIç»„åˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Mode Toggle Modal -->
        <div id="modeToggleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <h3 class="text-lg font-bold mb-4">åˆ‡æ¢æŠ•èµ„æ¨¡å¼</h3>
                <div class="space-y-3 mb-6">
                    <label class="flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="portfolioMode" value="manual" class="text-blue-600">
                        <div>
                            <p class="font-medium">æ‰‹åŠ¨ç®¡ç†</p>
                            <p class="text-sm text-gray-600">å®Œå…¨æ‰‹åŠ¨æ§åˆ¶ä¹°å–å†³ç­–</p>
                        </div>
                    </label>
                    <label class="flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="portfolioMode" value="hybrid" class="text-blue-600">
                        <div>
                            <p class="font-medium">æ··åˆæ¨¡å¼</p>
                            <p class="text-sm text-gray-600">AIæ¨èï¼Œæ‰‹åŠ¨ç¡®è®¤æ‰§è¡Œ</p>
                        </div>
                    </label>
                    <label class="flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="portfolioMode" value="auto" class="text-blue-600">
                        <div>
                            <p class="font-medium">å®Œå…¨è‡ªåŠ¨</p>
                            <p class="text-sm text-gray-600">AIè‡ªåŠ¨æ‰§è¡Œä¹°å–å†³ç­–</p>
                        </div>
                    </label>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideModeToggleModal()" 
                            class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button type="button" onclick="confirmModeChange()" 
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        ç¡®è®¤åˆ‡æ¢
                    </button>
                </div>
            </div>
        </div>
    </div>

        <!-- Investment Tools Tab -->
        <div id="toolsTab" class="tab-content hidden">
            <!-- Investment Tools Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 max-w-6xl mx-auto">
                <!-- Stock Screener -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-filter mr-3 text-blue-600"></i>æ™ºèƒ½è‚¡ç¥¨ç­›é€‰å™¨
                    </h3>
                    
                    <!-- Screener Controls -->
                    <div class="grid grid-cols-1 gap-4 mb-4">
                        <!-- Quick Filters -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å¸‚å€¼èŒƒå›´</label>
                                <select id="marketCapFilter" class="w-full border rounded px-2 py-1 text-sm">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="large">å¤§ç›˜è‚¡</option>
                                    <option value="mid">ä¸­ç›˜è‚¡</option>
                                    <option value="small">å°ç›˜è‚¡</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å¸‚ç›ˆç‡</label>
                                <select id="peFilter" class="w-full border rounded px-2 py-1 text-sm">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="low">ä½ä¼°å€¼</option>
                                    <option value="medium">åˆç†</option>
                                    <option value="high">é«˜ä¼°å€¼</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ¶¨è·Œå¹…</label>
                                <select id="priceChangeFilter" class="w-full border rounded px-2 py-1 text-sm">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="up5">æ¶¨å¹…>5%</option>
                                    <option value="up2">æ¶¨å¹…>2%</option>
                                    <option value="down2">è·Œå¹…>2%</option>
                                    <option value="down5">è·Œå¹…>5%</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">è¡Œä¸š</label>
                                <select id="sectorFilter" class="w-full border rounded px-2 py-1 text-sm">
                                    <option value="">å…¨éƒ¨è¡Œä¸š</option>
                                    <option value="technology">ç§‘æŠ€</option>
                                    <option value="healthcare">åŒ»ç–—</option>
                                    <option value="financial">é‡‘è</option>
                                    <option value="consumer">æ¶ˆè´¹</option>
                                    <option value="energy">èƒ½æº</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button onclick="screenStocks()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
                            <i class="fas fa-search mr-1"></i>ç­›é€‰è‚¡ç¥¨
                        </button>
                        <button onclick="resetScreener()" class="bg-gray-500 text-white px-4 py-2 rounded text-sm hover:bg-gray-600">
                            <i class="fas fa-undo mr-1"></i>é‡ç½®
                        </button>
                    </div>
                
                <!-- Loading State -->
                <div id="screenerLoading" class="text-center py-8 hidden">
                    <i class="fas fa-spinner loading text-2xl text-blue-600"></i>
                    <p class="mt-2 text-gray-600">æ­£åœ¨ç­›é€‰è‚¡ç¥¨...</p>
                </div>
                
                <!-- Results Table -->
                <div id="screenerResults" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">ç­›é€‰ç»“æœ</h3>
                        <div class="text-sm text-gray-600">
                            å…±æ‰¾åˆ° <span id="resultCount">0</span> åªè‚¡ç¥¨
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">è‚¡ç¥¨ä»£ç </th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">å…¬å¸åç§°</th>
                                    <th class="border border-gray-200 px-4 py-2 text-right">å½“å‰ä»·æ ¼</th>
                                    <th class="border border-gray-200 px-4 py-2 text-right">æ¶¨è·Œå¹…</th>
                                    <th class="border border-gray-200 px-4 py-2 text-right">å¸‚å€¼</th>
                                    <th class="border border-gray-200 px-4 py-2 text-right">å¸‚ç›ˆç‡</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">è¡Œä¸š</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <!-- Results will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div id="screenerEmpty" class="text-center py-12 text-gray-500 hidden">
                    <i class="fas fa-search text-4xl mb-4"></i>
                    <p class="mb-4">ç‚¹å‡»"ç­›é€‰è‚¡ç¥¨"å¼€å§‹ç­›é€‰</p>
                    <p class="text-sm">æ ¹æ®æ‚¨çš„æ¡ä»¶ç­›é€‰æœ€ç¬¦åˆçš„æŠ•èµ„æ ‡çš„</p>
                </div>
            </div>
            
            <!-- Investment Calculators -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-6xl mx-auto">
                
                <!-- å¤åˆ©è®¡ç®—å™¨ -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-chart-line mr-3 text-green-600"></i>å¤åˆ©è®¡ç®—å™¨
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">åˆå§‹æŠ•èµ„ (å…ƒ)</label>
                            <input type="number" id="compoundPrincipal" class="w-full border rounded-lg px-3 py-2" placeholder="100000" value="100000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å¹´åŒ–æ”¶ç›Šç‡ (%)</label>
                            <input type="number" id="compoundRate" class="w-full border rounded-lg px-3 py-2" placeholder="8" value="8" step="0.1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æŠ•èµ„å¹´é™</label>
                            <input type="number" id="compoundYears" class="w-full border rounded-lg px-3 py-2" placeholder="10" value="10">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å®šæœŸæŠ•å…¥ (å…ƒ/å¹´)</label>
                            <input type="number" id="compoundMonthly" class="w-full border rounded-lg px-3 py-2" placeholder="12000" value="0">
                        </div>
                        <button onclick="calculateCompound()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                            è®¡ç®—å¤åˆ©
                        </button>
                        <div id="compoundResult" class="mt-4 p-4 bg-green-50 rounded-lg hidden">
                            <h4 class="font-semibold text-green-800 mb-2">è®¡ç®—ç»“æœ</h4>
                            <div id="compoundResultContent"></div>
                        </div>
                    </div>
                </div>

                <!-- æ­¢æŸæ­¢ç›ˆè®¡ç®—å™¨ -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-shield-alt mr-3 text-red-600"></i>æ­¢æŸæ­¢ç›ˆè®¡ç®—å™¨
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ä¹°å…¥ä»·æ ¼ (å…ƒ)</label>
                            <input type="number" id="entryPrice" class="w-full border rounded-lg px-3 py-2" placeholder="100" value="100" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ­¢æŸæ¯”ä¾‹ (%)</label>
                            <input type="number" id="stopLossPercent" class="w-full border rounded-lg px-3 py-2" placeholder="5" value="5" step="0.1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ­¢ç›ˆæ¯”ä¾‹ (%)</label>
                            <input type="number" id="takeProfitPercent" class="w-full border rounded-lg px-3 py-2" placeholder="15" value="15" step="0.1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æŠ•èµ„é‡‘é¢ (å…ƒ)</label>
                            <input type="number" id="investmentAmount" class="w-full border rounded-lg px-3 py-2" placeholder="10000" value="10000">
                        </div>
                        <button onclick="calculateStopLoss()" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">
                            è®¡ç®—æ­¢æŸæ­¢ç›ˆ
                        </button>
                        <div id="stopLossResult" class="mt-4 p-4 bg-red-50 rounded-lg hidden">
                            <h4 class="font-semibold text-red-800 mb-2">è®¡ç®—ç»“æœ</h4>
                            <div id="stopLossResultContent"></div>
                        </div>
                    </div>
                </div>

                <!-- ä»“ä½ç®¡ç†è®¡ç®—å™¨ -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-balance-scale mr-3 text-blue-600"></i>ä»“ä½ç®¡ç†è®¡ç®—å™¨
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ€»èµ„é‡‘ (å…ƒ)</label>
                            <input type="number" id="totalCapital" class="w-full border rounded-lg px-3 py-2" placeholder="1000000" value="1000000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å•ç¬”é£é™©æ¯”ä¾‹ (%)</label>
                            <input type="number" id="riskPercent" class="w-full border rounded-lg px-3 py-2" placeholder="2" value="2" step="0.1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ä¹°å…¥ä»·æ ¼ (å…ƒ)</label>
                            <input type="number" id="positionEntryPrice" class="w-full border rounded-lg px-3 py-2" placeholder="100" value="100" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ­¢æŸä»·æ ¼ (å…ƒ)</label>
                            <input type="number" id="positionStopPrice" class="w-full border rounded-lg px-3 py-2" placeholder="95" value="95" step="0.01">
                        </div>
                        <button onclick="calculatePosition()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                            è®¡ç®—ä»“ä½
                        </button>
                        <div id="positionResult" class="mt-4 p-4 bg-blue-50 rounded-lg hidden">
                            <h4 class="font-semibold text-blue-800 mb-2">è®¡ç®—ç»“æœ</h4>
                            <div id="positionResultContent"></div>
                        </div>
                    </div>
                </div>

                <!-- é£é™©æ”¶ç›Šæ¯”è®¡ç®—å™¨ -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-chart-bar mr-3 text-purple-600"></i>é£é™©æ”¶ç›Šæ¯”è®¡ç®—å™¨
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ä¹°å…¥ä»·æ ¼ (å…ƒ)</label>
                            <input type="number" id="rrEntryPrice" class="w-full border rounded-lg px-3 py-2" placeholder="100" value="100" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç›®æ ‡ä»·æ ¼ (å…ƒ)</label>
                            <input type="number" id="rrTargetPrice" class="w-full border rounded-lg px-3 py-2" placeholder="120" value="120" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ­¢æŸä»·æ ¼ (å…ƒ)</label>
                            <input type="number" id="rrStopPrice" class="w-full border rounded-lg px-3 py-2" placeholder="95" value="95" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">èƒœç‡ä¼°è®¡ (%)</label>
                            <input type="number" id="winRate" class="w-full border rounded-lg px-3 py-2" placeholder="60" value="60" step="1">
                        </div>
                        <button onclick="calculateRiskReward()" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">
                            è®¡ç®—é£é™©æ”¶ç›Šæ¯”
                        </button>
                        <div id="riskRewardResult" class="mt-4 p-4 bg-purple-50 rounded-lg hidden">
                            <h4 class="font-semibold text-purple-800 mb-2">è®¡ç®—ç»“æœ</h4>
                            <div id="riskRewardResultContent"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content hidden">
            <div class="max-w-2xl mx-auto">
                <div class="bg-white shadow rounded-lg p-8">
                    <h3 class="text-2xl font-bold mb-8 flex items-center text-center justify-center">
                        <i class="fas fa-language mr-3 text-blue-600"></i><span data-i18n="language_settings">è¯­è¨€è®¾ç½®</span>
                    </h3>
                    
                    <!-- Language Selection -->
                    <div class="text-center">
                        <div class="mb-6">
                            <label class="block text-lg font-medium text-gray-700 mb-4">
                                <span data-i18n="select_language">é€‰æ‹©è¯­è¨€</span>
                            </label>
                            <select id="languageSelect" class="w-full max-w-xs mx-auto border border-gray-300 rounded-lg px-4 py-3 text-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                                <option value="zh" data-i18n="chinese">ä¸­æ–‡</option>
                                <option value="en" data-i18n="english">English</option>
                            </select>
                        </div>
                        
                        <div class="mb-8">
                            <label class="flex items-center justify-center">
                                <input type="checkbox" id="autoTranslateNews" class="mr-3 h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="text-gray-700" data-i18n="auto_translate_news">è‡ªåŠ¨ç¿»è¯‘æ–°é—»</span>
                            </label>
                        </div>
                        
                        <!-- Save Button -->
                        <button id="saveSettingsBtn" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors text-lg font-medium">
                            <i class="fas fa-save mr-2"></i><span data-i18n="save_settings">ä¿å­˜è®¾ç½®</span>
                        </button>
                        
                        <!-- Success Message -->
                        <div id="settingsSuccess" class="mt-6 p-3 bg-green-50 border border-green-200 text-green-700 rounded-lg hidden">
                            <i class="fas fa-check-circle mr-2"></i><span data-i18n="settings_saved">è®¾ç½®å·²ä¿å­˜</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-16">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2024 Stock AI Advisor. AIé©±åŠ¨çš„ä¸“ä¸šæŠ•èµ„å†³ç­–å¹³å°</p>
        </div>
    </footer>

    <script>
        let chart = null;
        let currentTicker = '';
        let currentChartType = 'line';  // é»˜è®¤å›¾è¡¨ç±»å‹

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from all tabs
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('tab-active', 'text-blue-600');
                    b.classList.add('text-gray-600');
                });
                
                // Add active class to clicked tab
                this.classList.add('tab-active', 'text-blue-600');
                this.classList.remove('text-gray-600');

                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });

                // Show corresponding tab content
                const tabId = this.id.replace('tab', '').toLowerCase() + 'Tab';
                document.getElementById(tabId).classList.remove('hidden');
                
                // Control stock search section visibility
                const stockSearchSection = document.getElementById('stockSearchSection');
                if (tabId === 'settingsTab') {
                    stockSearchSection.style.display = 'none';
                } else {
                    stockSearchSection.style.display = 'block';
                }
                
                // Load data when dashboard tab is activated
                if (tabId === 'dashboardTab') {
                    loadMarketDashboard();
                }
                
                // Show empty states for other tabs if no analysis has been done
                if (tabId === 'stockTab' && document.getElementById('stockAnalysisResults').classList.contains('hidden')) {
                    document.getElementById('stockAnalysisEmpty').classList.remove('hidden');
                }
                if (tabId === 'fundamentalTab' && document.getElementById('fundamentalAnalysisResults').classList.contains('hidden')) {
                    document.getElementById('fundamentalAnalysisEmpty').classList.remove('hidden');
                }
                if (tabId === 'riskTab' && document.getElementById('riskAnalysisResults').classList.contains('hidden')) {
                    document.getElementById('riskAnalysisEmpty').classList.remove('hidden');
                }
            });
        });

        // Load market data and news on page load
        window.addEventListener('load', function() {
            loadMarketData();
            loadNews();
            
            // Load dashboard data since it's the default tab
            loadMarketDashboard();
            startDashboardUpdates();
            
            // ä¸»æœç´¢åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨
            setupMainSearchListeners();
        });
        
        // è®¾ç½®ä¸»æœç´¢åŠŸèƒ½çš„äº‹ä»¶ç›‘å¬å™¨
        function setupMainSearchListeners() {
            // ä¸»æœç´¢æŒ‰é’®ç‚¹å‡»
            document.getElementById('mainSearchBtn').addEventListener('click', function() {
                const ticker = document.getElementById('mainTicker').value.trim();
                if (ticker) {
                    performIntelligentAnalysis(ticker);
                } else {
                    alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                }
            });
            
            // ä¸»æœç´¢æ¡†å›è½¦é”®
            document.getElementById('mainTicker').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const ticker = this.value.trim();
                    if (ticker) {
                        performIntelligentAnalysis(ticker);
                    } else {
                        alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                    }
                }
            });
            
            // å¿«æ·è‚¡ç¥¨æŒ‰é’®
            document.querySelectorAll('.quick-stock-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const symbol = this.dataset.symbol;
                    document.getElementById('mainTicker').value = symbol;
                    performIntelligentAnalysis(symbol);
                });
            });
        }

        async function loadMarketData() {
            try {
                const response = await fetch('/market');
                if (response.ok) {
                    const data = await response.json();
                    displayMarketData(data);
                }
            } catch (error) {
                console.error('åŠ è½½å¸‚åœºæ•°æ®å¤±è´¥:', error);
            } finally {
                document.getElementById('marketLoading').classList.add('hidden');
                document.getElementById('marketData').classList.remove('hidden');
            }
        }

        function displayMarketData(data) {
            // Display indices
            const indicesHtml = data.indices.map(index => `
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold">${index.name}</h3>
                            <p class="text-2xl font-bold mt-1">${index.price.toLocaleString()}</p>
                        </div>
                        <div class="${index.change_pct > 0 ? 'text-green-600' : 'text-red-600'} text-right">
                            <p class="text-lg font-bold">${index.change > 0 ? '+' : ''}${index.change.toFixed(2)}</p>
                            <p>${index.change_pct > 0 ? '+' : ''}${index.change_pct.toFixed(2)}%</p>
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('indices').innerHTML = indicesHtml;

            // Display gainers
            const gainersHtml = data.gainers.map(stock => `
                <li class="flex justify-between bg-white px-3 py-2 rounded">
                    <span class="font-medium">${stock.symbol}</span>
                    <span class="text-green-600">+${stock.change}%</span>
                </li>
            `).join('');
            document.getElementById('gainers').innerHTML = gainersHtml;

            // Display losers
            const losersHtml = data.losers.map(stock => `
                <li class="flex justify-between bg-white px-3 py-2 rounded">
                    <span class="font-medium">${stock.symbol}</span>
                    <span class="text-red-600">${stock.change}%</span>
                </li>
            `).join('');
            document.getElementById('losers').innerHTML = losersHtml;
        }

        // Stock search functionality
        document.getElementById('searchBtn').addEventListener('click', searchStock);
        document.getElementById('ticker').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStock();
            }
        });

        // Period selector
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.period-btn').forEach(b => {
                    b.classList.remove('bg-blue-500', 'text-white');
                    b.classList.add('border-gray-300');
                });
                this.classList.add('bg-blue-500', 'text-white');
                this.classList.remove('border-gray-300');
                
                if (currentTicker) {
                    searchStock(this.dataset.period);
                }
            });
        });

        // Chart type selector
        document.querySelectorAll('.chart-type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.chart-type-btn').forEach(b => {
                    b.classList.remove('bg-blue-500', 'text-white');
                    b.classList.add('border-gray-300');
                });
                this.classList.add('bg-blue-500', 'text-white');
                this.classList.remove('border-gray-300');
                
                currentChartType = this.dataset.type;
                
                if (currentTicker) {
                    // é‡æ–°ç»˜åˆ¶å½“å‰æ•°æ®çš„å›¾è¡¨
                    const activePeriodBtn = document.querySelector('.period-btn.bg-blue-500');
                    const period = activePeriodBtn ? activePeriodBtn.dataset.period : '3mo';
                    searchStock(period);
                }
            });
        });

        async function searchStock(period = '3mo') {
            const ticker = document.getElementById('ticker').value.trim().toUpperCase();
            if (!ticker) {
                showError('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            currentTicker = ticker;
            showLoading();
            hideError();

            try {
                const response = await fetch(`/stock/${ticker}?period=${period}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'è·å–è‚¡ç¥¨æ•°æ®å¤±è´¥');
                }

                displayStockData(data);
                document.getElementById('periodSelector').classList.remove('hidden');
                
                // æ›´æ–°æ–°é—»æ˜¾ç¤º
                updateNewsForStock(ticker);
            } catch (error) {
                showError(`æŸ¥è¯¢å¤±è´¥: ${error.message}`);
                console.error('è‚¡ç¥¨æŸ¥è¯¢å¤±è´¥:', error);
            } finally {
                hideLoading();
            }
        }

        function displayStockData(data) {
            document.getElementById('result').classList.remove('hidden');
            
            // Set badge color based on decision
            const badge = document.getElementById('badge');
            badge.textContent = data.decision;
            if (data.decision === 'BUY') {
                badge.className = 'px-4 py-2 rounded-lg text-white text-lg font-bold bg-green-500';
            } else if (data.decision === 'SELL') {
                badge.className = 'px-4 py-2 rounded-lg text-white text-lg font-bold bg-red-500';
            } else {
                badge.className = 'px-4 py-2 rounded-lg text-white text-lg font-bold bg-yellow-500';
            }

            document.getElementById('tickerLabel').textContent = data.ticker;
            document.getElementById('companyNameLabel').textContent = data.company_name || data.ticker;
            document.getElementById('price').textContent = `$${data.current_price}`;
            document.getElementById('open').textContent = `$${data.open}`;
            document.getElementById('high').textContent = `$${data.high}`;
            document.getElementById('low').textContent = `$${data.low}`;
            document.getElementById('volume').textContent = data.volume.toLocaleString();

            // Display reasons
            const reasonsList = document.getElementById('reasonsList');
            reasonsList.innerHTML = data.reasons.map(reason => 
                `<li class="flex items-start"><i class="fas fa-check text-blue-600 mt-1 mr-2"></i>${reason}</li>`
            ).join('');

            // Draw chart
            drawChart(data.history);
        }

        function drawChart(history, isRetry = false) {
            // è°ƒè¯•è¾“å‡º
            console.log('ç»˜åˆ¶å›¾è¡¨ï¼Œæ•°æ®:', history);
            
            // æ¸…é™¤ä¹‹å‰çš„å›¾è¡¨
            const chartContainer = document.getElementById('priceChart');
            chartContainer.innerHTML = '';
            
            // å‡†å¤‡æ•°æ®
            const labels = history.map(item => item.date);
            const prices = history.map(item => item.close);
            
            if (currentChartType === 'line') {
                // çº¿å›¾ - ä½¿ç”¨Chart.jsï¼Œéœ€è¦åˆ›å»ºcanvaså…ƒç´ 
                const canvas = document.createElement('canvas');
                canvas.width = chartContainer.offsetWidth;
                canvas.height = 400;
                chartContainer.appendChild(canvas);
                
                const ctx = canvas.getContext('2d');
                
                if (chart) {
                    chart.destroy();
                }
                
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æ”¶ç›˜ä»·',
                            data: prices,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `ä»·æ ¼: $${context.raw}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                display: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });
            } else {
                // Kçº¿å›¾ - ä½¿ç”¨TradingView Lightweight Charts
                try {
                    console.log('å°è¯•ç»˜åˆ¶Kçº¿å›¾...');
                    
                    // ç¡®ä¿TradingViewå›¾è¡¨åº“å·²åŠ è½½
                    if (typeof LightweightCharts === 'undefined') {
                        throw new Error('TradingViewå›¾è¡¨åº“æœªåŠ è½½');
                    }
                    
                    // åˆ›å»ºå›¾è¡¨
                    const chartOptions = {
                        width: chartContainer.offsetWidth,
                        height: 400,
                        layout: {
                            backgroundColor: '#ffffff',
                            textColor: '#333',
                        },
                        grid: {
                            vertLines: {
                                color: 'rgba(197, 203, 206, 0.5)',
                            },
                            horzLines: {
                                color: 'rgba(197, 203, 206, 0.5)',
                            },
                        },
                        timeScale: {
                            timeVisible: true,
                            secondsVisible: false,
                        },
                    };
                    
                    // åˆ›å»ºå›¾è¡¨å®ä¾‹
                    const tvChart = LightweightCharts.createChart(chartContainer, chartOptions);
                    
                    // å‡†å¤‡Kçº¿æ•°æ®
                    const candleData = history.map(item => ({
                        time: item.date.substring(0, 10), // æ ¼å¼: YYYY-MM-DD
                        open: parseFloat(item.open || item.close),
                        high: parseFloat(item.high || item.close),
                        low: parseFloat(item.low || item.close),
                        close: parseFloat(item.close)
                    }));
                    
                    // æ·»åŠ Kçº¿æ•°æ®ç³»åˆ—
                    const candleSeries = tvChart.addCandlestickSeries({
                        upColor: '#26a69a',
                        downColor: '#ef5350',
                        borderVisible: false,
                        wickUpColor: '#26a69a',
                        wickDownColor: '#ef5350'
                    });
                    
                    // è®¾ç½®æ•°æ®
                    candleSeries.setData(candleData);
                    
                    // è°ƒæ•´æ—¶é—´èŒƒå›´ä»¥æ˜¾ç¤ºæ‰€æœ‰æ•°æ®
                    tvChart.timeScale().fitContent();
                    
                    // ä¿å­˜å›¾è¡¨å¼•ç”¨ä»¥ä¾¿åç»­æ¸…ç†
                    chart = tvChart;
                    
                    console.log('Kçº¿å›¾ç»˜åˆ¶å®Œæˆ');
                } catch (e) {
                    console.error('Kçº¿å›¾ç»˜åˆ¶å¤±è´¥:', e);
                    
                    // å¦‚æœKçº¿å›¾å¤±è´¥ï¼Œå›é€€åˆ°çº¿å›¾
                    console.warn('Kçº¿å›¾åŠ è½½å¤±è´¥ï¼Œå›é€€åˆ°çº¿å›¾æ˜¾ç¤º');
                    
                    // ç›´æ¥ç»˜åˆ¶çº¿å›¾ï¼Œé¿å…æ— é™å¾ªç¯
                    currentChartType = 'line';
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.querySelectorAll('.chart-type-btn').forEach(btn => {
                        btn.classList.remove('bg-blue-500', 'text-white');
                        btn.classList.add('border-gray-300', 'hover:bg-gray-100');
                    });
                    document.querySelector('.chart-type-btn[data-type="line"]').classList.add('bg-blue-500', 'text-white');
                    
                    // é‡æ–°ç»˜åˆ¶ä¸ºçº¿å›¾ï¼ˆé˜²æ­¢æ— é™é€’å½’ï¼‰
                    if (!isRetry) {
                        drawChart(history, true);
                    }
                }
            }
        }

        function showLoading() {
            document.getElementById('searchLoading').classList.remove('hidden');
            document.getElementById('result').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('searchLoading').classList.add('hidden');
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = message;
            errorEl.classList.remove('hidden');
            errorEl.classList.add('error-shake');
            setTimeout(() => {
                errorEl.classList.remove('error-shake');
            }, 500);
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Fundamental Analysis Functions
        document.getElementById('fundamentalSearchBtn').addEventListener('click', analyzeFundamental);
        document.getElementById('fundamentalTicker').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeFundamental();
            }
        });

        async function analyzeFundamental() {
            const ticker = document.getElementById('fundamentalTicker').value.trim().toUpperCase();
            if (!ticker) {
                showFundamentalError('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            showFundamentalLoading();
            hideFundamentalError();

            try {
                // Get financial metrics
                const response = await fetch(`/fundamental/${ticker}`);
                const healthResponse = await fetch(`/fundamental/${ticker}/health`);
                
                if (!response.ok || !healthResponse.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'è·å–åŸºæœ¬é¢æ•°æ®å¤±è´¥');
                }

                const metrics = await response.json();
                const health = await healthResponse.json();

                displayFundamentalData(metrics, health);
            } catch (error) {
                showFundamentalError(`åˆ†æå¤±è´¥: ${error.message}`);
                console.error('åŸºæœ¬é¢åˆ†æå¤±è´¥:', error);
            } finally {
                hideFundamentalLoading();
            }
        }

        function displayFundamentalData(metrics, health) {
            document.getElementById('fundamentalResults').classList.remove('hidden');

            // Company Info
            document.getElementById('companyName').textContent = metrics.company_name || metrics.ticker;
            document.getElementById('companySector').textContent = `${metrics.sector} - ${metrics.industry}`;
            document.getElementById('marketCap').textContent = metrics.market_cap ? 
                `$${(metrics.market_cap / 1e9).toFixed(1)}B` : 'N/A';
            document.getElementById('peRatio').textContent = metrics.pe_ratio ? 
                metrics.pe_ratio.toFixed(1) : 'N/A';
            document.getElementById('pbRatio').textContent = metrics.pb_ratio ? 
                metrics.pb_ratio.toFixed(1) : 'N/A';

            // Health Scores
            document.getElementById('overallScore').textContent = health.overall_score.toFixed(1);
            document.getElementById('profitabilityScore').textContent = health.profitability_score.toFixed(1);
            document.getElementById('liquidityScore').textContent = health.liquidity_score.toFixed(1);
            document.getElementById('leverageScore').textContent = health.leverage_score.toFixed(1);
            document.getElementById('efficiencyScore').textContent = health.efficiency_score.toFixed(1);
            document.getElementById('growthScore').textContent = health.growth_score.toFixed(1);

            // Strengths and Weaknesses
            document.getElementById('strengthsList').innerHTML = health.strengths.map(s => 
                `<li class="flex items-start"><i class="fas fa-check text-green-600 mt-1 mr-2"></i>${s}</li>`
            ).join('');
            
            document.getElementById('weaknessesList').innerHTML = health.weaknesses.map(w => 
                `<li class="flex items-start"><i class="fas fa-times text-red-600 mt-1 mr-2"></i>${w}</li>`
            ).join('');
        }

        function showFundamentalLoading() {
            document.getElementById('fundamentalLoading').classList.remove('hidden');
            document.getElementById('fundamentalResults').classList.add('hidden');
        }

        function hideFundamentalLoading() {
            document.getElementById('fundamentalLoading').classList.add('hidden');
        }

        function showFundamentalError(message) {
            const errorDiv = document.getElementById('fundamentalError');
            const errorText = document.getElementById('fundamentalErrorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideFundamentalError() {
            document.getElementById('fundamentalError').classList.add('hidden');
        }

        // Risk Management Functions
        document.getElementById('riskAnalyzeBtn').addEventListener('click', analyzeRisk);
        document.getElementById('riskTicker').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeRisk();
            }
        });

        async function analyzeRisk() {
            const ticker = document.getElementById('riskTicker').value.trim().toUpperCase();
            if (!ticker) {
                showRiskError('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            showRiskLoading();
            hideRiskError();

            try {
                // Get comprehensive risk analysis
                const response = await fetch(`/risk/${ticker}/comprehensive`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'è·å–é£é™©æ•°æ®å¤±è´¥');
                }

                const risk = await response.json();
                displayRiskData(risk);
            } catch (error) {
                showRiskError(`é£é™©åˆ†æå¤±è´¥: ${error.message}`);
                console.error('é£é™©åˆ†æå¤±è´¥:', error);
            } finally {
                hideRiskLoading();
            }
        }

        function displayRiskData(risk) {
            document.getElementById('riskResults').classList.remove('hidden');

            // Risk Overview
            document.getElementById('riskLevel').textContent = risk.overall_risk_level;
            document.getElementById('riskLevel').className = `text-3xl font-bold mb-2 ${getRiskColor(risk.overall_risk_level)}`;
            document.getElementById('riskScore').textContent = `${risk.risk_score.toFixed(1)}/100`;
            
            // VaR Analysis
            if (risk.var_analysis) {
                document.getElementById('var95').textContent = risk.var_analysis.historical_var ? 
                    `${risk.var_analysis.historical_var.toFixed(2)}%` : 'N/A';
                document.getElementById('worstDay').textContent = risk.var_analysis.worst_day_loss ? 
                    `${risk.var_analysis.worst_day_loss.toFixed(2)}%` : 'N/A';
            }

            // Drawdown Analysis
            if (risk.drawdown_analysis) {
                document.getElementById('maxDrawdown').textContent = risk.drawdown_analysis.max_drawdown ? 
                    `${risk.drawdown_analysis.max_drawdown.toFixed(2)}%` : 'N/A';
                document.getElementById('currentDrawdown').textContent = risk.drawdown_analysis.current_drawdown ? 
                    `${risk.drawdown_analysis.current_drawdown.toFixed(2)}%` : 'N/A';
                document.getElementById('recoveryTime').textContent = risk.drawdown_analysis.recovery_time_avg ? 
                    `${risk.drawdown_analysis.recovery_time_avg.toFixed(0)}å¤©` : 'N/A';
            }

            // Volatility
            if (risk.volatility_analysis) {
                document.getElementById('volatility').textContent = risk.volatility_analysis.annualized_volatility ? 
                    `${risk.volatility_analysis.annualized_volatility.toFixed(1)}%` : 'N/A';
            }

            // Position Sizing
            if (risk.position_sizing) {
                document.getElementById('conservativePosition').textContent = risk.position_sizing.conservative_position ? 
                    `${risk.position_sizing.conservative_position.toFixed(1)}%` : 'N/A';
                document.getElementById('recommendedPosition').textContent = risk.position_sizing.recommended_position ? 
                    `${risk.position_sizing.recommended_position.toFixed(1)}%` : 'N/A';
                document.getElementById('aggressivePosition').textContent = risk.position_sizing.aggressive_position ? 
                    `${risk.position_sizing.aggressive_position.toFixed(1)}%` : 'N/A';
                document.getElementById('kellyPosition').textContent = risk.position_sizing.kelly_percentage ? 
                    `${risk.position_sizing.kelly_percentage.toFixed(1)}%` : 'N/A';
            }

            // Risk Warnings
            const warnings = risk.risk_mitigation_suggestions || [];
            document.getElementById('riskWarningsList').innerHTML = warnings.map(w => 
                `<li class="flex items-start"><i class="fas fa-exclamation-triangle text-yellow-600 mt-1 mr-2"></i>${w}</li>`
            ).join('');
        }

        function getRiskColor(riskLevel) {
            switch(riskLevel) {
                case 'LOW': return 'text-green-600';
                case 'MEDIUM': return 'text-yellow-600';
                case 'HIGH': return 'text-orange-600';
                case 'EXTREME': return 'text-red-600';
                default: return 'text-gray-600';
            }
        }

        function showRiskLoading() {
            document.getElementById('riskLoading').classList.remove('hidden');
            document.getElementById('riskResults').classList.add('hidden');
        }

        function hideRiskLoading() {
            document.getElementById('riskLoading').classList.add('hidden');
        }

        function showRiskError(message) {
            const errorDiv = document.getElementById('riskError');
            const errorText = document.getElementById('riskErrorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideRiskError() {
            document.getElementById('riskError').classList.add('hidden');
        }

        // Portfolio Management Functions
        let currentPortfolioId = null;

        // Load portfolios when portfolio tab is activated
        document.getElementById('tabPortfolio').addEventListener('click', loadPortfolios);

        async function loadPortfolios() {
            showPortfolioLoading();
            try {
                const response = await fetch('/portfolios');
                if (response.ok) {
                    const portfolios = await response.json();
                    displayPortfolioList(portfolios);
                } else {
                    throw new Error('åŠ è½½æŠ•èµ„ç»„åˆå¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½æŠ•èµ„ç»„åˆå¤±è´¥:', error);
                document.getElementById('portfolioEmpty').classList.remove('hidden');
            } finally {
                hidePortfolioLoading();
            }
        }

        function displayPortfolioList(portfolios) {
            const portfolioList = document.getElementById('portfolioList');
            const portfolioEmpty = document.getElementById('portfolioEmpty');
            
            if (portfolios.length === 0) {
                portfolioList.innerHTML = '';
                portfolioEmpty.classList.remove('hidden');
                return;
            }
            
            portfolioEmpty.classList.add('hidden');
            
            portfolioList.innerHTML = portfolios.map(portfolio => `
                <div class="bg-white shadow rounded-lg p-6 hover:shadow-lg transition-shadow cursor-pointer" 
                     onclick="viewPortfolioDetails('${portfolio.id}')">
                    <!-- Portfolio Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-briefcase text-blue-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">${portfolio.name}</h3>
                                <p class="text-sm text-gray-600">${portfolio.description || 'æ™ºèƒ½æŠ•èµ„ç»„åˆ'}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-gray-900">$${portfolio.total_value.toFixed(2)}</div>
                            <div class="text-sm ${portfolio.total_pnl_pct >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${portfolio.total_pnl_pct >= 0 ? '+' : ''}${portfolio.total_pnl_pct.toFixed(2)}%
                            </div>
                        </div>
                    </div>
                    
                    <!-- Portfolio Metrics -->
                    <div class="grid grid-cols-3 gap-4 pt-4 border-t border-gray-100">
                        <div class="text-center">
                            <div class="text-sm text-gray-600">æŒä»“æ•°é‡</div>
                            <div class="text-lg font-semibold text-gray-900">${portfolio.holdings_count}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-sm text-gray-600">æ€»ç›ˆäº</div>
                            <div class="text-lg font-semibold ${portfolio.total_pnl >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${portfolio.total_pnl >= 0 ? '+' : ''}$${Math.abs(portfolio.total_pnl).toFixed(2)}
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-sm text-gray-600">ç±»å‹</div>
                            <div class="text-lg font-semibold text-purple-600">${portfolio.portfolio_type || 'æ‰‹åŠ¨'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function viewPortfolioDetails(portfolioId) {
            currentPortfolioId = portfolioId;
            showPortfolioLoading();
            
            try {
                const response = await fetch(`/portfolio/${portfolioId}`);
                if (response.ok) {
                    const portfolio = await response.json();
                    displayPortfolioDetails(portfolio);
                } else {
                    throw new Error('åŠ è½½æŠ•èµ„ç»„åˆè¯¦æƒ…å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½æŠ•èµ„ç»„åˆè¯¦æƒ…å¤±è´¥:', error);
                alert('åŠ è½½æŠ•èµ„ç»„åˆè¯¦æƒ…å¤±è´¥');
            } finally {
                hidePortfolioLoading();
            }
        }

        function displayPortfolioDetails(portfolio) {
            // Hide list, show details
            document.querySelector('#portfolioTab .bg-white:first-child').classList.add('hidden');
            document.getElementById('portfolioDetails').classList.remove('hidden');
            
            // Update portfolio info
            document.getElementById('portfolioDetailsName').textContent = portfolio.name;
            document.getElementById('portfolioDetailsDesc').textContent = portfolio.description || 'æš‚æ— æè¿°';
            
            // Update summary
            document.getElementById('portfolioTotalValue').textContent = `$${portfolio.total_value.toFixed(2)}`;
            document.getElementById('portfolioTotalPnL').textContent = `$${portfolio.total_pnl.toFixed(2)}`;
            document.getElementById('portfolioTotalPnL').className = `text-2xl font-bold ${portfolio.total_pnl >= 0 ? 'text-green-600' : 'text-red-600'}`;
            document.getElementById('portfolioTotalPnLPct').textContent = `${portfolio.total_pnl_pct >= 0 ? '+' : ''}${portfolio.total_pnl_pct.toFixed(2)}%`;
            document.getElementById('portfolioTotalPnLPct').className = `text-2xl font-bold ${portfolio.total_pnl_pct >= 0 ? 'text-green-600' : 'text-red-600'}`;
            document.getElementById('portfolioHoldingsCount').textContent = portfolio.holdings.length;
            
            // Update holdings display
            displayHoldings(portfolio.holdings);
        }
        
        // æ–°çš„æŒä»“æ˜¾ç¤ºå‡½æ•°
        function displayHoldings(holdings) {
            const holdingsContainer = document.getElementById('holdingsContainer');
            const holdingsTableBody = document.getElementById('holdingsTableBody');
            const holdingsEmpty = document.getElementById('holdingsEmpty');
            const holdingsSection = holdingsContainer?.closest('.bg-white');
            
            if (holdings.length === 0) {
                holdingsSection?.classList.add('hidden');
                holdingsEmpty?.classList.remove('hidden');
                return;
            }
            
            holdingsEmpty?.classList.add('hidden');
            holdingsSection?.classList.remove('hidden');
            
            // å¡ç‰‡è§†å›¾ï¼ˆé»˜è®¤ï¼‰
            if (holdingsContainer) {
                holdingsContainer.innerHTML = holdings.map(holding => `
                    <div class="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <span class="text-blue-600 font-bold text-sm">${holding.ticker}</span>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-900">${holding.ticker}</div>
                                    <div class="text-sm text-gray-600">${holding.shares} è‚¡</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-gray-900">$${holding.market_value.toFixed(2)}</div>
                                <div class="text-sm ${holding.unrealized_pnl_pct >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${holding.unrealized_pnl_pct >= 0 ? '+' : ''}${holding.unrealized_pnl_pct.toFixed(2)}%
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                            <div>
                                <div class="text-gray-600">æˆæœ¬ä»·</div>
                                <div class="font-medium">$${holding.avg_cost.toFixed(2)}</div>
                            </div>
                            <div>
                                <div class="text-gray-600">å½“å‰ä»·</div>
                                <div class="font-medium">$${holding.current_price.toFixed(2)}</div>
                            </div>
                            <div>
                                <div class="text-gray-600">ç›ˆäº</div>
                                <div class="font-medium ${holding.unrealized_pnl >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${holding.unrealized_pnl >= 0 ? '+' : ''}$${Math.abs(holding.unrealized_pnl).toFixed(2)}
                                </div>
                            </div>
                            <div>
                                <div class="text-gray-600">æƒé‡</div>
                                <div class="font-medium">${holding.weight.toFixed(1)}%</div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end mt-3 pt-3 border-t border-gray-200">
                            <button onclick="removeHolding('${holding.ticker}')" 
                                    class="text-red-600 hover:text-red-800 text-sm px-2 py-1 rounded hover:bg-red-50">
                                <i class="fas fa-trash mr-1"></i>ç§»é™¤
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            // è¡¨æ ¼è§†å›¾
            if (holdingsTableBody) {
                holdingsTableBody.innerHTML = holdings.map(holding => `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 p-3 font-medium">${holding.ticker}</td>
                        <td class="border border-gray-200 p-3 text-right">${holding.shares}</td>
                        <td class="border border-gray-200 p-3 text-right">$${holding.avg_cost.toFixed(2)}</td>
                        <td class="border border-gray-200 p-3 text-right">$${holding.current_price.toFixed(2)}</td>
                        <td class="border border-gray-200 p-3 text-right">$${holding.market_value.toFixed(2)}</td>
                        <td class="border border-gray-200 p-3 text-right ${holding.unrealized_pnl >= 0 ? 'text-green-600' : 'text-red-600'}">
                            $${holding.unrealized_pnl.toFixed(2)}
                        </td>
                        <td class="border border-gray-200 p-3 text-right ${holding.unrealized_pnl_pct >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${holding.unrealized_pnl_pct >= 0 ? '+' : ''}${holding.unrealized_pnl_pct.toFixed(2)}%
                        </td>
                        <td class="border border-gray-200 p-3 text-right">${holding.weight.toFixed(1)}%</td>
                        <td class="border border-gray-200 p-3 text-center">
                            <button onclick="removeHolding('${holding.ticker}')" 
                                    class="text-red-600 hover:text-red-800 text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }
        
        // è§†å›¾åˆ‡æ¢åŠŸèƒ½åˆå§‹åŒ–
        function initPortfolioViewToggle() {
            const cardViewBtn = document.getElementById('cardViewBtn');
            const tableViewBtn = document.getElementById('tableViewBtn');
            const holdingsContainer = document.getElementById('holdingsContainer');
            const holdingsTableView = document.getElementById('holdingsTableView');
            
            cardViewBtn?.addEventListener('click', function() {
                holdingsContainer?.classList.remove('hidden');
                holdingsTableView?.classList.add('hidden');
                cardViewBtn.classList.add('bg-blue-500', 'text-white');
                cardViewBtn.classList.remove('border', 'hover:bg-gray-100');
                tableViewBtn?.classList.remove('bg-blue-500', 'text-white');
                tableViewBtn?.classList.add('border', 'hover:bg-gray-100');
            });
            
            tableViewBtn?.addEventListener('click', function() {
                holdingsContainer?.classList.add('hidden');
                holdingsTableView?.classList.remove('hidden');
                tableViewBtn.classList.add('bg-blue-500', 'text-white');
                tableViewBtn.classList.remove('border', 'hover:bg-gray-100');
                cardViewBtn?.classList.remove('bg-blue-500', 'text-white');
                cardViewBtn?.classList.add('border', 'hover:bg-gray-100');
            });
        }

        function showPortfolioLoading() {
            document.getElementById('portfolioLoading').classList.remove('hidden');
        }

        function hidePortfolioLoading() {
            document.getElementById('portfolioLoading').classList.add('hidden');
        }

        // Modal functions
        function showCreatePortfolioModal() {
            document.getElementById('createPortfolioModal').classList.remove('hidden');
        }

        function hideCreatePortfolioModal() {
            document.getElementById('createPortfolioModal').classList.add('hidden');
            document.getElementById('createPortfolioForm').reset();
        }

        function showAddHoldingModal() {
            document.getElementById('addHoldingModal').classList.remove('hidden');
        }

        function hideAddHoldingModal() {
            document.getElementById('addHoldingModal').classList.add('hidden');
            document.getElementById('addHoldingForm').reset();
        }

        // Event listeners
        document.getElementById('createPortfolioBtn').addEventListener('click', showCreatePortfolioModal);
        document.getElementById('addHoldingBtn').addEventListener('click', showAddHoldingModal);
        document.getElementById('backToListBtn').addEventListener('click', backToPortfolioList);

        document.getElementById('createPortfolioForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                description: formData.get('description')
            };
            
            try {
                const response = await fetch('/portfolio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    hideCreatePortfolioModal();
                    loadPortfolios();
                } else {
                    const error = await response.json();
                    alert(`åˆ›å»ºå¤±è´¥: ${error.detail}`);
                }
            } catch (error) {
                alert(`åˆ›å»ºå¤±è´¥: ${error.message}`);
            }
        });

        document.getElementById('addHoldingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentPortfolioId) return;
            
            const formData = new FormData(e.target);
            const data = {
                ticker: formData.get('ticker').toUpperCase(),
                shares: parseFloat(formData.get('shares')),
                cost_per_share: parseFloat(formData.get('cost_per_share'))
            };
            
            try {
                const response = await fetch(`/portfolio/${currentPortfolioId}/holding`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    hideAddHoldingModal();
                    viewPortfolioDetails(currentPortfolioId);
                } else {
                    const error = await response.json();
                    alert(`æ·»åŠ å¤±è´¥: ${error.detail}`);
                }
            } catch (error) {
                alert(`æ·»åŠ å¤±è´¥: ${error.message}`);
            }
        });

        async function removeHolding(ticker) {
            if (!currentPortfolioId) return;
            
            if (!confirm(`ç¡®å®šè¦ç§»é™¤ ${ticker} çš„æŒä»“å—ï¼Ÿ`)) return;
            
            try {
                const response = await fetch(`/portfolio/${currentPortfolioId}/holding/${ticker}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    viewPortfolioDetails(currentPortfolioId);
                } else {
                    const error = await response.json();
                    alert(`ç§»é™¤å¤±è´¥: ${error.detail}`);
                }
            } catch (error) {
                alert(`ç§»é™¤å¤±è´¥: ${error.message}`);
            }
        }

        document.getElementById('deletePortfolioBtn').addEventListener('click', async function() {
            if (!currentPortfolioId) return;
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æŠ•èµ„ç»„åˆå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) return;
            
            try {
                const response = await fetch(`/portfolio/${currentPortfolioId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    backToPortfolioList();
                    loadPortfolios();
                } else {
                    const error = await response.json();
                    alert(`åˆ é™¤å¤±è´¥: ${error.detail}`);
                }
            } catch (error) {
                alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        });

        function backToPortfolioList() {
            document.getElementById('portfolioDetails').classList.add('hidden');
            document.querySelector('#portfolioTab .bg-white:first-child').classList.remove('hidden');
            currentPortfolioId = null;
        }

        // Close modals when clicking outside
        document.getElementById('createPortfolioModal').addEventListener('click', function(e) {
            if (e.target === this) hideCreatePortfolioModal();
        });

        document.getElementById('addHoldingModal').addEventListener('click', function(e) {
            if (e.target === this) hideAddHoldingModal();
        });

        // ==================== æ–°é—»åŠŸèƒ½ ====================
        
        let currentNewsType = 'market';
        let currentNewsTicker = null;
        
        async function loadNews(type = 'market', ticker = null) {
            try {
                document.getElementById('newsLoading').classList.remove('hidden');
                document.getElementById('newsData').classList.add('hidden');
                document.getElementById('newsError').classList.add('hidden');
                
                let url;
                if (type === 'stock' && ticker) {
                    url = `/stock-updates/${ticker}`;
                } else {
                    url = '/market-updates';
                }
                
                const response = await fetch(url);
                if (response.ok) {
                    const newsData = await response.json();
                    displayNews(newsData, type);
                } else {
                    throw new Error('æ— æ³•è·å–æ–°é—»æ•°æ®');
                }
            } catch (error) {
                console.error('åŠ è½½æ–°é—»å¤±è´¥:', error);
                document.getElementById('newsError').classList.remove('hidden');
            } finally {
                document.getElementById('newsLoading').classList.add('hidden');
                document.getElementById('newsData').classList.remove('hidden');
            }
        }
        
        function displayNews(newsData, type) {
            if (!newsData || newsData.length === 0) {
                document.getElementById('newsContent').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-newspaper text-4xl mb-4"></i>
                        <p>æš‚æ— æ–°é—»æ•°æ®</p>
                    </div>
                `;
                return;
            }
            
            const newsHtml = newsData.map(news => {
                const publishedDate = new Date(news.published_at).toLocaleString('zh-CN');
                const sentimentBadge = news.sentiment ? getSentimentBadge(news.sentiment, news.sentiment_score) : '';
                const tickerTags = news.tickers && news.tickers.length > 0 ? 
                    `<div class="mt-2">
                        ${news.tickers.slice(0, 3).map(ticker => 
                            `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs mr-1">${ticker}</span>`
                        ).join('')}
                    </div>` : '';
                
                return `
                    <div class="bg-gray-50 p-4 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold text-gray-900 leading-tight hover:text-blue-600 cursor-pointer"
                                onclick="window.open('${news.url}', '_blank')">
                                ${news.title}
                            </h4>
                            ${sentimentBadge}
                        </div>
                        
                        ${news.summary ? `<p class="text-gray-600 text-sm mb-3 line-clamp-2">${news.summary}</p>` : ''}
                        
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <div class="flex items-center space-x-3">
                                <span class="flex items-center">
                                    <i class="fas fa-globe mr-1"></i>
                                    ${news.source}
                                </span>
                                <span class="flex items-center">
                                    <i class="fas fa-clock mr-1"></i>
                                    ${publishedDate}
                                </span>
                            </div>
                            <a href="${news.url}" target="_blank" 
                               class="text-blue-500 hover:text-blue-700 flex items-center">
                                <i class="fas fa-external-link-alt mr-1"></i>
                                é˜…è¯»å…¨æ–‡
                            </a>
                        </div>
                        ${tickerTags}
                    </div>
                `;
            }).join('');
            
            document.getElementById('newsContent').innerHTML = newsHtml;
        }
        
        function getSentimentBadge(sentiment, score) {
            let badgeClass, icon;
            
            switch(sentiment) {
                case 'ç§¯æ':
                    badgeClass = 'bg-green-100 text-green-800';
                    icon = 'fas fa-smile';
                    break;
                case 'æ¶ˆæ':
                    badgeClass = 'bg-red-100 text-red-800';
                    icon = 'fas fa-frown';
                    break;
                default:
                    badgeClass = 'bg-gray-100 text-gray-800';
                    icon = 'fas fa-meh';
            }
            
            return `
                <span class="inline-flex items-center px-2 py-1 rounded text-xs ${badgeClass}">
                    <i class="${icon} mr-1"></i>
                    ${sentiment} ${score ? `(${(score * 100).toFixed(0)}%)` : ''}
                </span>
            `;
        }
        
        // æ–°é—»æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.news-tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const type = this.dataset.type;
                
                // æ›´æ–°æ ‡ç­¾é¡µæ ·å¼
                document.querySelectorAll('.news-tab-btn').forEach(b => {
                    b.classList.remove('border-blue-500', 'text-blue-600');
                    b.classList.add('text-gray-500', 'hover:text-gray-700');
                });
                this.classList.add('border-blue-500', 'text-blue-600');
                this.classList.remove('text-gray-500', 'hover:text-gray-700');
                
                currentNewsType = type;
                
                if (type === 'market') {
                    loadNews('market');
                } else if (type === 'stock' && currentNewsTicker) {
                    loadNews('stock', currentNewsTicker);
                } else {
                    // å¦‚æœæ²¡æœ‰é€‰ä¸­è‚¡ç¥¨ï¼Œæ˜¾ç¤ºæç¤º
                    document.getElementById('newsContent').innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-info-circle text-4xl mb-4"></i>
                            <p>è¯·å…ˆæœç´¢è‚¡ç¥¨ä»¥æŸ¥çœ‹ç›¸å…³æ–°é—»</p>
                        </div>
                    `;
                }
            });
        });
        
        // åŠ è½½æ›´å¤šæ–°é—»
        document.getElementById('loadMoreNews').addEventListener('click', function() {
            if (currentNewsType === 'market') {
                loadNews('market');
            } else if (currentNewsType === 'stock' && currentNewsTicker) {
                loadNews('stock', currentNewsTicker);
            }
        });
        
        // å½“æœç´¢è‚¡ç¥¨æ—¶ï¼Œæ›´æ–°æ–°é—»æ˜¾ç¤º
        function updateNewsForStock(ticker) {
            currentNewsTicker = ticker;
            if (currentNewsType === 'stock') {
                loadNews('stock', ticker);
            }
        }

        // ==================== æŠ•èµ„è®¡ç®—å™¨åŠŸèƒ½ ====================
        
        // å¤åˆ©è®¡ç®—å™¨
        function calculateCompound() {
            const principal = parseFloat(document.getElementById('compoundPrincipal').value) || 0;
            const rate = parseFloat(document.getElementById('compoundRate').value) / 100 || 0;
            const years = parseInt(document.getElementById('compoundYears').value) || 0;
            const monthly = parseFloat(document.getElementById('compoundMonthly').value) || 0;
            
            if (principal <= 0 || rate <= 0 || years <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼');
                return;
            }
            
            // è®¡ç®—å¤åˆ©
            let futureValue = principal * Math.pow(1 + rate, years);
            
            // è®¡ç®—å®šæœŸæŠ•å…¥çš„å¤åˆ©
            if (monthly > 0) {
                const monthlyRate = rate;
                const monthlyContribution = monthly * ((Math.pow(1 + monthlyRate, years) - 1) / monthlyRate);
                futureValue += monthlyContribution;
            }
            
            const totalInvestment = principal + (monthly * years);
            const totalReturn = futureValue - totalInvestment;
            const annualizedReturn = ((futureValue / totalInvestment) ** (1/years) - 1) * 100;
            
            document.getElementById('compoundResult').classList.remove('hidden');
            document.getElementById('compoundResultContent').innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>æ€»æŠ•èµ„:</span>
                        <span class="font-bold">Â¥${totalInvestment.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>æœ€ç»ˆä»·å€¼:</span>
                        <span class="font-bold text-green-600">Â¥${futureValue.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>æ€»æ”¶ç›Š:</span>
                        <span class="font-bold text-green-600">Â¥${totalReturn.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>å¹´åŒ–æ”¶ç›Šç‡:</span>
                        <span class="font-bold">${annualizedReturn.toFixed(2)}%</span>
                    </div>
                    <div class="flex justify-between">
                        <span>æ”¶ç›Šå€æ•°:</span>
                        <span class="font-bold">${(futureValue / totalInvestment).toFixed(2)}x</span>
                    </div>
                </div>
            `;
        }
        
        // æ­¢æŸæ­¢ç›ˆè®¡ç®—å™¨
        function calculateStopLoss() {
            const entryPrice = parseFloat(document.getElementById('entryPrice').value) || 0;
            const stopLossPercent = parseFloat(document.getElementById('stopLossPercent').value) || 0;
            const takeProfitPercent = parseFloat(document.getElementById('takeProfitPercent').value) || 0;
            const investmentAmount = parseFloat(document.getElementById('investmentAmount').value) || 0;
            
            if (entryPrice <= 0 || stopLossPercent <= 0 || takeProfitPercent <= 0 || investmentAmount <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼');
                return;
            }
            
            const stopLossPrice = entryPrice * (1 - stopLossPercent / 100);
            const takeProfitPrice = entryPrice * (1 + takeProfitPercent / 100);
            const shares = Math.floor(investmentAmount / entryPrice);
            const actualInvestment = shares * entryPrice;
            
            const maxLoss = actualInvestment * (stopLossPercent / 100);
            const maxProfit = actualInvestment * (takeProfitPercent / 100);
            const riskRewardRatio = takeProfitPercent / stopLossPercent;
            
            document.getElementById('stopLossResult').classList.remove('hidden');
            document.getElementById('stopLossResultContent').innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>ä¹°å…¥ä»·æ ¼:</span>
                        <span class="font-bold">Â¥${entryPrice.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>æ­¢æŸä»·æ ¼:</span>
                        <span class="font-bold text-red-600">Â¥${stopLossPrice.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>æ­¢ç›ˆä»·æ ¼:</span>
                        <span class="font-bold text-green-600">Â¥${takeProfitPrice.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>å¯ä¹°è‚¡æ•°:</span>
                        <span class="font-bold">${shares}è‚¡</span>
                    </div>
                    <div class="flex justify-between">
                        <span>å®é™…æŠ•èµ„:</span>
                        <span class="font-bold">Â¥${actualInvestment.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>æœ€å¤§äºæŸ:</span>
                        <span class="font-bold text-red-600">Â¥${maxLoss.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>æœ€å¤§ç›ˆåˆ©:</span>
                        <span class="font-bold text-green-600">Â¥${maxProfit.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>é£é™©æ”¶ç›Šæ¯”:</span>
                        <span class="font-bold">1:${riskRewardRatio.toFixed(2)}</span>
                    </div>
                </div>
            `;
        }
        
        // ä»“ä½ç®¡ç†è®¡ç®—å™¨
        function calculatePosition() {
            const totalCapital = parseFloat(document.getElementById('totalCapital').value) || 0;
            const riskPercent = parseFloat(document.getElementById('riskPercent').value) || 0;
            const entryPrice = parseFloat(document.getElementById('positionEntryPrice').value) || 0;
            const stopPrice = parseFloat(document.getElementById('positionStopPrice').value) || 0;
            
            if (totalCapital <= 0 || riskPercent <= 0 || entryPrice <= 0 || stopPrice <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼');
                return;
            }
            
            if (stopPrice >= entryPrice) {
                alert('æ­¢æŸä»·æ ¼åº”è¯¥ä½äºä¹°å…¥ä»·æ ¼');
                return;
            }
            
            const riskAmount = totalCapital * (riskPercent / 100);
            const priceRisk = entryPrice - stopPrice;
            const shares = Math.floor(riskAmount / priceRisk);
            const positionValue = shares * entryPrice;
            const positionPercent = (positionValue / totalCapital) * 100;
            
            document.getElementById('positionResult').classList.remove('hidden');
            document.getElementById('positionResultContent').innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>æ€»èµ„é‡‘:</span>
                        <span class="font-bold">Â¥${totalCapital.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>é£é™©é‡‘é¢:</span>
                        <span class="font-bold text-red-600">Â¥${riskAmount.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>å•è‚¡é£é™©:</span>
                        <span class="font-bold">Â¥${priceRisk.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>å»ºè®®è‚¡æ•°:</span>
                        <span class="font-bold text-blue-600">${shares}è‚¡</span>
                    </div>
                    <div class="flex justify-between">
                        <span>ä»“ä½ä»·å€¼:</span>
                        <span class="font-bold">Â¥${positionValue.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>ä»“ä½å æ¯”:</span>
                        <span class="font-bold">${positionPercent.toFixed(2)}%</span>
                    </div>
                    <div class="mt-3 p-2 bg-yellow-100 rounded text-sm">
                        <strong>å»ºè®®:</strong> æ ¹æ®${riskPercent}%çš„é£é™©æ§åˆ¶ï¼Œå»ºè®®ä¹°å…¥${shares}è‚¡ï¼Œå ç”¨èµ„é‡‘${positionPercent.toFixed(1)}%
                    </div>
                </div>
            `;
        }
        
        // é£é™©æ”¶ç›Šæ¯”è®¡ç®—å™¨
        function calculateRiskReward() {
            const entryPrice = parseFloat(document.getElementById('rrEntryPrice').value) || 0;
            const targetPrice = parseFloat(document.getElementById('rrTargetPrice').value) || 0;
            const stopPrice = parseFloat(document.getElementById('rrStopPrice').value) || 0;
            const winRate = parseFloat(document.getElementById('winRate').value) || 0;
            
            if (entryPrice <= 0 || targetPrice <= 0 || stopPrice <= 0 || winRate <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼');
                return;
            }
            
            if (targetPrice <= entryPrice) {
                alert('ç›®æ ‡ä»·æ ¼åº”è¯¥é«˜äºä¹°å…¥ä»·æ ¼');
                return;
            }
            
            if (stopPrice >= entryPrice) {
                alert('æ­¢æŸä»·æ ¼åº”è¯¥ä½äºä¹°å…¥ä»·æ ¼');
                return;
            }
            
            const reward = targetPrice - entryPrice;
            const risk = entryPrice - stopPrice;
            const riskRewardRatio = reward / risk;
            const rewardPercent = (reward / entryPrice) * 100;
            const riskPercent = (risk / entryPrice) * 100;
            
            // è®¡ç®—æœŸæœ›æ”¶ç›Š
            const expectedReturn = (winRate / 100) * rewardPercent - ((100 - winRate) / 100) * riskPercent;
            
            // åˆ¤æ–­äº¤æ˜“è´¨é‡
            let quality = '';
            let qualityColor = '';
            if (riskRewardRatio >= 3) {
                quality = 'ä¼˜ç§€';
                qualityColor = 'text-green-600';
            } else if (riskRewardRatio >= 2) {
                quality = 'è‰¯å¥½';
                qualityColor = 'text-blue-600';
            } else if (riskRewardRatio >= 1.5) {
                quality = 'ä¸€èˆ¬';
                qualityColor = 'text-yellow-600';
            } else {
                quality = 'è¾ƒå·®';
                qualityColor = 'text-red-600';
            }
            
            document.getElementById('riskRewardResult').classList.remove('hidden');
            document.getElementById('riskRewardResultContent').innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>ä¹°å…¥ä»·æ ¼:</span>
                        <span class="font-bold">Â¥${entryPrice.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>ç›®æ ‡ä»·æ ¼:</span>
                        <span class="font-bold text-green-600">Â¥${targetPrice.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>æ­¢æŸä»·æ ¼:</span>
                        <span class="font-bold text-red-600">Â¥${stopPrice.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>æ½œåœ¨æ”¶ç›Š:</span>
                        <span class="font-bold text-green-600">+${rewardPercent.toFixed(2)}%</span>
                    </div>
                    <div class="flex justify-between">
                        <span>æ½œåœ¨é£é™©:</span>
                        <span class="font-bold text-red-600">-${riskPercent.toFixed(2)}%</span>
                    </div>
                    <div class="flex justify-between">
                        <span>é£é™©æ”¶ç›Šæ¯”:</span>
                        <span class="font-bold">1:${riskRewardRatio.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>æœŸæœ›æ”¶ç›Š:</span>
                        <span class="font-bold ${expectedReturn >= 0 ? 'text-green-600' : 'text-red-600'}">${expectedReturn >= 0 ? '+' : ''}${expectedReturn.toFixed(2)}%</span>
                    </div>
                    <div class="flex justify-between">
                        <span>äº¤æ˜“è´¨é‡:</span>
                        <span class="font-bold ${qualityColor}">${quality}</span>
                    </div>
                    <div class="mt-3 p-2 bg-purple-100 rounded text-sm">
                        <strong>å»ºè®®:</strong> ${expectedReturn >= 0 ? 'æœŸæœ›æ”¶ç›Šä¸ºæ­£ï¼Œ' : 'æœŸæœ›æ”¶ç›Šä¸ºè´Ÿï¼Œ'} 
                        ${riskRewardRatio >= 2 ? 'é£é™©æ”¶ç›Šæ¯”åˆç†ï¼Œå¯è€ƒè™‘äº¤æ˜“' : 'é£é™©æ”¶ç›Šæ¯”åä½ï¼Œå»ºè®®è°¨æ…'}
                    </div>
                </div>
            `;
        }
        
        // ==================== å¸‚åœºä»ªè¡¨æ¿åŠŸèƒ½ ====================
        
        // åŠ è½½å¸‚åœºä»ªè¡¨æ¿æ•°æ®
        async function loadMarketDashboard() {
            try {
                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
                const [dashboardResponse, movesResponse, sentimentResponse] = await Promise.all([
                    fetch('/market-dashboard'),
                    fetch('/market-movers'),
                    fetch('/market-sentiment')
                ]);
                
                if (dashboardResponse.ok && movesResponse.ok && sentimentResponse.ok) {
                    const dashboardData = await dashboardResponse.json();
                    const movesData = await movesResponse.json();
                    const sentimentData = await sentimentResponse.json();
                    
                    if (dashboardData.success) {
                        updateMarketIndices(dashboardData.data.market_indices);
                        updateSectorHeatmap(dashboardData.data.sector_heatmap);
                        updateMarketSentiment(dashboardData.data.market_sentiment);
                    }
                    
                    if (movesData.success) {
                        updateTopGainers(movesData.data.top_gainers);
                        updateTopLosers(movesData.data.top_losers);
                        updateVolumeLeaders(movesData.data.volume_leaders);
                    }
                    
                    // åŠ è½½å¸‚åœºæ–°é—»
                    loadDashboardNews();
                }
            } catch (error) {
                console.error('åŠ è½½å¸‚åœºä»ªè¡¨æ¿æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°å¸‚åœºæŒ‡æ•°
        function updateMarketIndices(indices) {
            // æ›´æ–°S&P 500
            if (indices.SPX) {
                document.getElementById('spxPrice').textContent = indices.SPX.price.toFixed(2);
                const changeElement = document.getElementById('spxChange');
                const change = indices.SPX.change >= 0 ? `+${indices.SPX.change.toFixed(2)}` : indices.SPX.change.toFixed(2);
                const changePercent = indices.SPX.change_percent >= 0 ? `+${indices.SPX.change_percent.toFixed(2)}%` : `${indices.SPX.change_percent.toFixed(2)}%`;
                changeElement.textContent = `${change} (${changePercent})`;
                changeElement.className = `text-sm ${indices.SPX.change >= 0 ? 'text-green-600' : 'text-red-600'}`;
            }
            
            // æ›´æ–°NASDAQ
            if (indices.NASDAQ) {
                document.getElementById('nasdaqPrice').textContent = indices.NASDAQ.price.toFixed(2);
                const changeElement = document.getElementById('nasdaqChange');
                const change = indices.NASDAQ.change >= 0 ? `+${indices.NASDAQ.change.toFixed(2)}` : indices.NASDAQ.change.toFixed(2);
                const changePercent = indices.NASDAQ.change_percent >= 0 ? `+${indices.NASDAQ.change_percent.toFixed(2)}%` : `${indices.NASDAQ.change_percent.toFixed(2)}%`;
                changeElement.textContent = `${change} (${changePercent})`;
                changeElement.className = `text-sm ${indices.NASDAQ.change >= 0 ? 'text-green-600' : 'text-red-600'}`;
            }
            
            // æ›´æ–°DOW
            if (indices.DOW) {
                document.getElementById('dowPrice').textContent = indices.DOW.price.toFixed(2);
                const changeElement = document.getElementById('dowChange');
                const change = indices.DOW.change >= 0 ? `+${indices.DOW.change.toFixed(2)}` : indices.DOW.change.toFixed(2);
                const changePercent = indices.DOW.change_percent >= 0 ? `+${indices.DOW.change_percent.toFixed(2)}%` : `${indices.DOW.change_percent.toFixed(2)}%`;
                changeElement.textContent = `${change} (${changePercent})`;
                changeElement.className = `text-sm ${indices.DOW.change >= 0 ? 'text-green-600' : 'text-red-600'}`;
            }
        }
        
        // æ›´æ–°è¡Œä¸šçƒ­åŠ›å›¾
        function updateSectorHeatmap(sectors) {
            const heatmapContainer = document.getElementById('sectorHeatmap');
            
            heatmapContainer.innerHTML = sectors.map(sector => {
                const changePercent = sector.change_percent;
                let colorClass = 'bg-gray-100 text-gray-800';
                
                if (changePercent > 1) {
                    colorClass = 'bg-green-500 text-white';
                } else if (changePercent > 0.3) {
                    colorClass = 'bg-green-300 text-green-900';
                } else if (changePercent > -0.3) {
                    colorClass = 'bg-gray-200 text-gray-700';
                } else if (changePercent > -1) {
                    colorClass = 'bg-red-300 text-red-900';
                } else {
                    colorClass = 'bg-red-500 text-white';
                }
                
                return `
                    <div class="p-3 rounded ${colorClass} text-center">
                        <div class="font-medium text-sm">${sector.name}</div>
                        <div class="text-xs mt-1">${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%</div>
                    </div>
                `;
            }).join('');
        }
        
        // æ›´æ–°å¸‚åœºæƒ…ç»ª
        function updateMarketSentiment(sentiment) {
            // æ›´æ–°ææƒ§è´ªå©ªæŒ‡æ•°
            const fearGreedBar = document.getElementById('fearGreedBar');
            const fearGreedValue = document.getElementById('fearGreedValue');
            
            fearGreedBar.style.width = `${sentiment.fear_greed_index}%`;
            fearGreedValue.textContent = `${sentiment.fear_greed_index} (${sentiment.fear_greed_label})`;
            
            // æ ¹æ®æŒ‡æ•°è®¾ç½®é¢œè‰²
            if (sentiment.fear_greed_index >= 60) {
                fearGreedBar.className = 'bg-green-500 h-2 rounded-full';
            } else if (sentiment.fear_greed_index >= 40) {
                fearGreedBar.className = 'bg-yellow-500 h-2 rounded-full';
            } else {
                fearGreedBar.className = 'bg-red-500 h-2 rounded-full';
            }
            
            // æ›´æ–°å…¶ä»–æŒ‡æ ‡
            document.getElementById('vixValue').textContent = sentiment.vix_value;
            document.getElementById('advanceDecline').textContent = `${sentiment.advance_decline_ratio}%`;
            document.getElementById('highLowRatio').textContent = sentiment.high_low_ratio;
        }
        
        // æ›´æ–°æ¶¨å¹…æ¦œ
        function updateTopGainers(gainers) {
            const container = document.getElementById('topGainers');
            
            container.innerHTML = gainers.map(stock => `
                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                    <div>
                        <div class="font-medium">${stock.symbol}</div>
                        <div class="text-sm text-gray-600">${stock.name}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-medium">$${stock.price.toFixed(2)}</div>
                        <div class="text-sm text-green-600">+${stock.change_percent.toFixed(2)}%</div>
                    </div>
                </div>
            `).join('');
        }
        
        // æ›´æ–°è·Œå¹…æ¦œ
        function updateTopLosers(losers) {
            const container = document.getElementById('topLosers');
            
            container.innerHTML = losers.map(stock => `
                <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                    <div>
                        <div class="font-medium">${stock.symbol}</div>
                        <div class="text-sm text-gray-600">${stock.name}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-medium">$${stock.price.toFixed(2)}</div>
                        <div class="text-sm text-red-600">${stock.change_percent.toFixed(2)}%</div>
                    </div>
                </div>
            `).join('');
        }
        
        // æ›´æ–°æˆäº¤é‡æ’è¡Œ
        function updateVolumeLeaders(leaders) {
            const container = document.getElementById('volumeLeaders');
            
            container.innerHTML = leaders.map(stock => `
                <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                    <div>
                        <div class="font-medium">${stock.symbol}</div>
                        <div class="text-sm text-gray-600">${stock.name}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-medium">$${stock.price.toFixed(2)}</div>
                        <div class="text-sm text-blue-600">${(stock.volume / 1000000).toFixed(1)}M</div>
                    </div>
                </div>
            `).join('');
        }
        
        // åŠ è½½ä»ªè¡¨æ¿æ–°é—»
        async function loadDashboardNews() {
            try {
                const response = await fetch('/market-updates?limit=5');
                if (response.ok) {
                    const data = await response.json();
                    // ç›´æ¥ä½¿ç”¨è¿”å›çš„æ•°ç»„ï¼Œä¸éœ€è¦ .news å­—æ®µ
                    updateDashboardNews(Array.isArray(data) ? data : []);
                }
            } catch (error) {
                console.error('åŠ è½½å¸‚åœºæ–°é—»å¤±è´¥:', error);
                // æ˜¾ç¤ºå¤‡ç”¨æ¶ˆæ¯
                updateDashboardNews([]);
            }
        }
        
        // æ›´æ–°ä»ªè¡¨æ¿æ–°é—»
        function updateDashboardNews(news) {
            const container = document.getElementById('dashboardNews');
            
            if (news.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4">æš‚æ— å¸‚åœºæ–°é—»</div>';
                return;
            }
            
            container.innerHTML = news.map(item => `
                <div class="border-b border-gray-200 pb-3 last:border-b-0">
                    <a href="${item.url}" target="_blank" class="block hover:text-blue-600">
                        <div class="font-medium text-sm line-clamp-2 mb-1">${item.title}</div>
                        <div class="text-xs text-gray-500 flex items-center">
                            <span>${item.source}</span>
                            <span class="mx-2">â€¢</span>
                            <span>${formatNewsTime(item.published_at)}</span>
                        </div>
                    </a>
                </div>
            `).join('');
        }
        
        // æ ¼å¼åŒ–æ–°é—»æ—¶é—´
        function formatNewsTime(timeString) {
            try {
                const date = new Date(timeString);
                const now = new Date();
                const diffMs = now - date;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                
                if (diffHours < 1) {
                    return 'åˆšåˆš';
                } else if (diffHours < 24) {
                    return `${diffHours}å°æ—¶å‰`;
                } else {
                    return `${Math.floor(diffHours / 24)}å¤©å‰`;
                }
            } catch (error) {
                return 'æœªçŸ¥æ—¶é—´';
            }
        }
        
        // å¯åŠ¨å®æ—¶æ›´æ–°
        function startDashboardUpdates() {
            // æ¯60ç§’æ›´æ–°ä¸€æ¬¡æ•°æ®
            setInterval(loadMarketDashboard, 60000);
        }
        
        // ==================== ä¸»æœç´¢åŠŸèƒ½ ====================
        
        // æ™ºèƒ½è‚¡ç¥¨åˆ†æ
        async function performIntelligentAnalysis(ticker) {
            const loadingElement = document.getElementById('mainSearchLoading');
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                loadingElement.classList.remove('hidden');
                
                // é‡ç½®æ‰€æœ‰æ ‡ç­¾é¡µåˆ°ç©ºçŠ¶æ€
                resetAllTabsToEmpty();
                
                // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰åˆ†æ
                const analysisPromises = [
                    fetch(`/stock/${ticker.toUpperCase()}`),  // åŸºç¡€è‚¡ç¥¨æ•°æ®
                    fetch(`/fundamental/${ticker.toUpperCase()}`),  // åŸºæœ¬é¢åˆ†æ
                    fetch(`/risk/${ticker.toUpperCase()}`),  // é£é™©åˆ†æ
                    fetch(`/stock-updates/${ticker.toUpperCase()}?limit=5`)  // è‚¡ç¥¨ç›¸å…³æ–°é—»
                ];
                
                // ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ
                const responses = await Promise.allSettled(analysisPromises);
                
                // å¤„ç†ç»“æœ
                const stockData = responses[0].status === 'fulfilled' && responses[0].value.ok ? 
                    await responses[0].value.json() : null;
                const fundamentalData = responses[1].status === 'fulfilled' && responses[1].value.ok ? 
                    await responses[1].value.json() : null;
                const riskData = responses[2].status === 'fulfilled' && responses[2].value.ok ? 
                    await responses[2].value.json() : null;
                const newsData = responses[3].status === 'fulfilled' && responses[3].value.ok ? 
                    await responses[3].value.json() : null;
                
                // æ˜¾ç¤ºåˆ†æç»“æœ
                displayIntelligentAnalysisResults(ticker, stockData, fundamentalData, riskData, newsData);
                
            } catch (error) {
                console.error('æ™ºèƒ½åˆ†æå¤±è´¥:', error);
                alert(`åˆ†æå¤±è´¥: ${error.message}`);
            } finally {
                loadingElement.classList.add('hidden');
            }
        }
        
        // æ˜¾ç¤ºæ™ºèƒ½åˆ†æç»“æœ
        function displayIntelligentAnalysisResults(ticker, stockData, fundamentalData, riskData, newsData) {
            // å¦‚æœè‚¡ç¥¨æ•°æ®å­˜åœ¨ï¼Œæ›´æ–°è‚¡ç¥¨åˆ†ææ ‡ç­¾é¡µ
            if (stockData) {
                document.getElementById('ticker').value = ticker;
                displayStockResult(stockData);
                
                // æ›´æ–°ä»·æ ¼èµ°åŠ¿å›¾
                if (stockData.chart_data) {
                    updateCharts(stockData.chart_data, 'line');
                }
            }
            
            // å¦‚æœåŸºæœ¬é¢æ•°æ®å­˜åœ¨ï¼Œæ›´æ–°åŸºæœ¬é¢åˆ†ææ ‡ç­¾é¡µ
            if (fundamentalData) {
                displayFundamentalAnalysis(fundamentalData);
            }
            
            // å¦‚æœé£é™©æ•°æ®å­˜åœ¨ï¼Œæ›´æ–°é£é™©ç®¡ç†æ ‡ç­¾é¡µ
            if (riskData) {
                displayRiskAnalysis(riskData);
            }
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å’Œå»ºè®®
            showAnalysisCompletedMessage(ticker, stockData, fundamentalData, riskData);
        }
        
        // æ˜¾ç¤ºåˆ†æå®Œæˆæ¶ˆæ¯
        function showAnalysisCompletedMessage(ticker, stockData, fundamentalData, riskData) {
            const analysisMessage = document.createElement('div');
            analysisMessage.className = 'mt-4 p-4 bg-green-50 border border-green-200 rounded-lg';
            analysisMessage.innerHTML = `
                <div class="flex items-center mb-2">
                    <i class="fas fa-check-circle text-green-600 mr-2"></i>
                    <span class="font-semibold text-green-800">${ticker.toUpperCase()} æ™ºèƒ½åˆ†æå®Œæˆï¼</span>
                </div>
                <div class="text-sm text-green-700">
                    å·²ä¸ºæ‚¨å‡†å¤‡äº†å®Œæ•´çš„æŠ•èµ„åˆ†ææŠ¥å‘Šï¼Œè¯·æŸ¥çœ‹å„ä¸ªæ ‡ç­¾é¡µï¼š
                    <div class="mt-2 flex flex-wrap gap-2">
                        ${stockData ? '<button onclick="showTab(\'stock\')" class="px-2 py-1 bg-green-100 hover:bg-green-200 rounded text-xs cursor-pointer">âœ“ è‚¡ç¥¨åˆ†æ</button>' : ''}
                        ${fundamentalData ? '<button onclick="showTab(\'fundamental\')" class="px-2 py-1 bg-green-100 hover:bg-green-200 rounded text-xs cursor-pointer">âœ“ åŸºæœ¬é¢åˆ†æ</button>' : ''}
                        ${riskData ? '<button onclick="showTab(\'risk\')" class="px-2 py-1 bg-green-100 hover:bg-green-200 rounded text-xs cursor-pointer">âœ“ é£é™©ç®¡ç†</button>' : ''}
                    </div>
                    <div class="mt-3 text-xs text-green-600">
                        ğŸ’¡ æç¤ºï¼šç‚¹å‡»ä¸Šæ–¹æ ‡ç­¾å¯ç›´æ¥è·³è½¬åˆ°å¯¹åº”åˆ†ææŠ¥å‘Š
                    </div>
                </div>
            `;
            
            // åˆ é™¤ä¹‹å‰çš„æ¶ˆæ¯
            const existingMessage = document.querySelector('.analysis-completed-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // æ·»åŠ æ–°æ¶ˆæ¯
            analysisMessage.classList.add('analysis-completed-message');
            document.getElementById('mainSearchLoading').parentNode.appendChild(analysisMessage);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
            setTimeout(() => {
                if (analysisMessage.parentNode) {
                    analysisMessage.remove();
                }
            }, 5000);
        }
        
        // æ˜¾ç¤ºè‚¡ç¥¨åˆ†æç»“æœ
        function displayStockResult(data) {
            // æ˜¾ç¤ºè‚¡ç¥¨åˆ†æç»“æœï¼Œéšè—ç©ºçŠ¶æ€
            document.getElementById('stockAnalysisResults').classList.remove('hidden');
            document.getElementById('stockAnalysisEmpty').classList.add('hidden');
            
            // æ›´æ–°è‚¡ç¥¨ä¿¡æ¯
            document.getElementById('tickerLabel').textContent = data.symbol;
            document.getElementById('companyNameLabel').textContent = data.company_name || '';
            document.getElementById('priceInfo').textContent = `$${data.current_price} | 24H: ${data.price_change >= 0 ? '+' : ''}${data.price_change_percent}%`;
            
            // æ›´æ–°å†³ç­–å¾½ç« 
            const badge = document.getElementById('badge');
            if (data.recommendation === 'BUY') {
                badge.textContent = 'ä¹°å…¥';
                badge.className = 'px-4 py-2 rounded-lg text-white text-lg font-bold bg-green-600';
            } else if (data.recommendation === 'SELL') {
                badge.textContent = 'å–å‡º';
                badge.className = 'px-4 py-2 rounded-lg text-white text-lg font-bold bg-red-600';
            } else {
                badge.textContent = 'æŒæœ‰';
                badge.className = 'px-4 py-2 rounded-lg text-white text-lg font-bold bg-yellow-600';
            }
            
            // æ›´æ–°åˆ†æåŸå› 
            const reasonsList = document.getElementById('reasonsList');
            if (data.reasons && Array.isArray(data.reasons)) {
                reasonsList.innerHTML = data.reasons.map(reason => 
                    `<li class="text-blue-700"><i class="fas fa-check-circle mr-2"></i>${reason}</li>`
                ).join('');
            }
        }
        
        // æ˜¾ç¤ºåŸºæœ¬é¢åˆ†æç»“æœ
        function displayFundamentalAnalysis(data) {
            // æ˜¾ç¤ºåŸºæœ¬é¢åˆ†æç»“æœï¼Œéšè—ç©ºçŠ¶æ€
            document.getElementById('fundamentalAnalysisResults').classList.remove('hidden');
            document.getElementById('fundamentalAnalysisEmpty').classList.add('hidden');
            
            // æ›´æ–°åŸºæœ¬é¢æ•°æ®æ˜¾ç¤º
            if (data.financial_metrics) {
                const metrics = data.financial_metrics;
                const metricsHtml = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-3 bg-blue-50 rounded">
                            <div class="text-2xl font-bold text-blue-600">${metrics.pe_ratio || 'N/A'}</div>
                            <div class="text-sm text-gray-600">å¸‚ç›ˆç‡</div>
                        </div>
                        <div class="text-center p-3 bg-green-50 rounded">
                            <div class="text-2xl font-bold text-green-600">${metrics.pb_ratio || 'N/A'}</div>
                            <div class="text-sm text-gray-600">å¸‚å‡€ç‡</div>
                        </div>
                        <div class="text-center p-3 bg-purple-50 rounded">
                            <div class="text-2xl font-bold text-purple-600">${metrics.roe || 'N/A'}%</div>
                            <div class="text-sm text-gray-600">å‡€èµ„äº§æ”¶ç›Šç‡</div>
                        </div>
                        <div class="text-center p-3 bg-orange-50 rounded">
                            <div class="text-2xl font-bold text-orange-600">${metrics.debt_to_equity || 'N/A'}</div>
                            <div class="text-sm text-gray-600">è´Ÿå€ºæƒç›Šæ¯”</div>
                        </div>
                    </div>
                `;
                document.getElementById('fundamentalMetrics').innerHTML = metricsHtml;
            }
        }
        
        // æ˜¾ç¤ºé£é™©åˆ†æç»“æœ
        function displayRiskAnalysis(data) {
            // æ˜¾ç¤ºé£é™©åˆ†æç»“æœï¼Œéšè—ç©ºçŠ¶æ€
            document.getElementById('riskAnalysisResults').classList.remove('hidden');
            document.getElementById('riskAnalysisEmpty').classList.add('hidden');
            
            // æ›´æ–°é£é™©åˆ†ææ•°æ®æ˜¾ç¤º
            if (data.risk_summary) {
                const summary = data.risk_summary;
                const riskHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-red-800 mb-2">é£é™©ç­‰çº§</h4>
                            <div class="text-2xl font-bold text-red-600">${summary.risk_level || 'ä¸­ç­‰'}</div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">å»ºè®®ä»“ä½</h4>
                            <div class="text-2xl font-bold text-blue-600">${summary.recommended_position || '5-10%'}</div>
                        </div>
                    </div>
                `;
                document.getElementById('riskSummary').innerHTML = riskHtml;
            }
        }
        
        // ç„¦ç‚¹åˆ°ä¸»æœç´¢æ¡†
        function focusMainSearch() {
            document.getElementById('mainTicker').focus();
            document.getElementById('mainTicker').scrollIntoView({ behavior: 'smooth' });
        }
        
        // é‡ç½®æ‰€æœ‰æ ‡ç­¾é¡µåˆ°ç©ºçŠ¶æ€
        function resetAllTabsToEmpty() {
            // éšè—æ‰€æœ‰ç»“æœï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            document.getElementById('stockAnalysisResults').classList.add('hidden');
            document.getElementById('stockAnalysisEmpty').classList.remove('hidden');
            
            document.getElementById('fundamentalAnalysisResults').classList.add('hidden');
            document.getElementById('fundamentalAnalysisEmpty').classList.remove('hidden');
            
            document.getElementById('riskAnalysisResults').classList.add('hidden');
            document.getElementById('riskAnalysisEmpty').classList.remove('hidden');
        }
        
        // æ ‡ç­¾é¡µåˆ‡æ¢å‡½æ•°
        function showTab(tabName) {
            // æ˜ å°„æ ‡ç­¾åç§°åˆ°å¯¹åº”çš„ID
            const tabMapping = {
                'dashboard': 'Dashboard',
                'stock': 'Stock', 
                'fundamental': 'Fundamental',
                'risk': 'Risk',
                'portfolio': 'Portfolio',
                'tools': 'Tools'
            };
            
            // è·å–å¯¹åº”çš„æ ‡ç­¾åç§°
            const mappedTabName = tabMapping[tabName.toLowerCase()];
            if (!mappedTabName) {
                console.error('Unknown tab name:', tabName);
                return;
            }
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active', 'text-blue-600');
                btn.classList.add('text-gray-600');
            });
            
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®
            const tabButton = document.getElementById('tab' + mappedTabName);
            if (tabButton) {
                tabButton.classList.add('tab-active', 'text-blue-600');
                tabButton.classList.remove('text-gray-600');
            }
            
            // æ˜¾ç¤ºå¯¹åº”çš„æ ‡ç­¾å†…å®¹
            const tabContent = document.getElementById(tabName.toLowerCase() + 'Tab');
            if (tabContent) {
                tabContent.classList.remove('hidden');
            }
        }
        
        // ==================== è‚¡ç¥¨ç­›é€‰å™¨åŠŸèƒ½ ====================
        
        // è‚¡ç¥¨ç­›é€‰åŠŸèƒ½
        async function screenStocks() {
            const loadingElement = document.getElementById('screenerLoading');
            const resultsElement = document.getElementById('screenerResults');
            const emptyElement = document.getElementById('screenerEmpty');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loadingElement.classList.remove('hidden');
            resultsElement.classList.add('hidden');
            emptyElement.classList.add('hidden');
            
            try {
                // è·å–ç­›é€‰æ¡ä»¶
                const filters = {
                    market_cap: document.getElementById('marketCap').value,
                    pe_ratio: document.getElementById('peRatio').value,
                    price_change: document.getElementById('priceChange').value,
                    volume: document.getElementById('volume').value,
                    sector: document.getElementById('sector').value,
                    sort_by: document.getElementById('sortBy').value
                };
                
                // ç§»é™¤ç©ºå€¼
                Object.keys(filters).forEach(key => {
                    if (!filters[key]) {
                        delete filters[key];
                    }
                });
                
                // è°ƒç”¨API
                const response = await fetch('/stock-screener', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(filters)
                });
                
                if (!response.ok) {
                    throw new Error('ç­›é€‰å¤±è´¥');
                }
                
                const data = await response.json();
                displayScreenerResults(data);
                
            } catch (error) {
                console.error('è‚¡ç¥¨ç­›é€‰å¤±è´¥:', error);
                alert('è‚¡ç¥¨ç­›é€‰å¤±è´¥ï¼Œè¯·é‡è¯•');
                emptyElement.classList.remove('hidden');
            } finally {
                loadingElement.classList.add('hidden');
            }
        }
        
        // æ˜¾ç¤ºç­›é€‰ç»“æœ
        function displayScreenerResults(results) {
            const resultsElement = document.getElementById('screenerResults');
            const emptyElement = document.getElementById('screenerEmpty');
            const tableBody = document.getElementById('resultsTableBody');
            const countElement = document.getElementById('resultCount');
            
            if (results.length === 0) {
                resultsElement.classList.add('hidden');
                emptyElement.classList.remove('hidden');
                return;
            }
            
            // æ›´æ–°ç»“æœè®¡æ•°
            countElement.textContent = results.length;
            
            // ç”Ÿæˆè¡¨æ ¼å†…å®¹
            tableBody.innerHTML = results.map(stock => `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-2 font-medium">${stock.symbol}</td>
                    <td class="border border-gray-200 px-4 py-2">${stock.name}</td>
                    <td class="border border-gray-200 px-4 py-2 text-right font-medium">$${stock.price.toFixed(2)}</td>
                    <td class="border border-gray-200 px-4 py-2 text-right ${stock.change_percent >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${stock.change_percent >= 0 ? '+' : ''}${stock.change_percent.toFixed(2)}%
                    </td>
                    <td class="border border-gray-200 px-4 py-2 text-right">${formatMarketCap(stock.market_cap)}</td>
                    <td class="border border-gray-200 px-4 py-2 text-right">${stock.pe_ratio.toFixed(1)}</td>
                    <td class="border border-gray-200 px-4 py-2">${getSectorName(stock.sector)}</td>
                    <td class="border border-gray-200 px-4 py-2 text-center">
                        <button onclick="analyzeStock('${stock.symbol}')" 
                                class="text-blue-600 hover:text-blue-800 text-sm mr-2">
                            <i class="fas fa-chart-line"></i>
                        </button>
                        <button onclick="addToWatchlist('${stock.symbol}')" 
                                class="text-green-600 hover:text-green-800 text-sm">
                            <i class="fas fa-plus"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // æ˜¾ç¤ºç»“æœ
            emptyElement.classList.add('hidden');
            resultsElement.classList.remove('hidden');
        }
        
        // é‡ç½®ç­›é€‰å™¨
        function resetScreener() {
            document.getElementById('marketCap').value = '';
            document.getElementById('peRatio').value = '';
            document.getElementById('priceChange').value = '';
            document.getElementById('volume').value = '';
            document.getElementById('sector').value = '';
            document.getElementById('sortBy').value = 'marketCap';
            
            // éšè—ç»“æœï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            document.getElementById('screenerResults').classList.add('hidden');
            document.getElementById('screenerLoading').classList.add('hidden');
            document.getElementById('screenerEmpty').classList.remove('hidden');
        }
        
        // å¯¼å‡ºç»“æœ
        function exportResults() {
            const tableBody = document.getElementById('resultsTableBody');
            const rows = tableBody.querySelectorAll('tr');
            
            if (rows.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            // å‡†å¤‡CSVæ•°æ®
            const csvData = [];
            csvData.push(['è‚¡ç¥¨ä»£ç ', 'å…¬å¸åç§°', 'å½“å‰ä»·æ ¼', 'æ¶¨è·Œå¹…', 'å¸‚å€¼', 'å¸‚ç›ˆç‡', 'è¡Œä¸š']);
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [
                    cells[0].textContent.trim(),
                    cells[1].textContent.trim(),
                    cells[2].textContent.trim(),
                    cells[3].textContent.trim(),
                    cells[4].textContent.trim(),
                    cells[5].textContent.trim(),
                    cells[6].textContent.trim()
                ];
                csvData.push(rowData);
            });
            
            // è½¬æ¢ä¸ºCSVæ ¼å¼
            const csvContent = csvData.map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
            
            // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `stock_screener_results_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–å¸‚å€¼
        function formatMarketCap(marketCap) {
            if (marketCap >= 1000000000000) {
                return (marketCap / 1000000000000).toFixed(1) + 'T';
            } else if (marketCap >= 1000000000) {
                return (marketCap / 1000000000).toFixed(1) + 'B';
            } else if (marketCap >= 1000000) {
                return (marketCap / 1000000).toFixed(1) + 'M';
            } else {
                return marketCap.toLocaleString();
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šè·å–è¡Œä¸šä¸­æ–‡å
        function getSectorName(sector) {
            const sectorMap = {
                'technology': 'ç§‘æŠ€',
                'healthcare': 'åŒ»ç–—',
                'financial': 'é‡‘è',
                'consumer': 'æ¶ˆè´¹',
                'energy': 'èƒ½æº',
                'industrial': 'å·¥ä¸š',
                'utilities': 'å…¬ç”¨äº‹ä¸š',
                'materials': 'ææ–™',
                'real_estate': 'æˆ¿åœ°äº§',
                'communication': 'é€šä¿¡'
            };
            return sectorMap[sector] || sector;
        }
        
        // åˆ†æè‚¡ç¥¨ï¼ˆè°ƒç”¨ç°æœ‰çš„è‚¡ç¥¨åˆ†æåŠŸèƒ½ï¼‰
        async function analyzeStock(symbol) {
            // åˆ‡æ¢åˆ°è‚¡ç¥¨åˆ†ææ ‡ç­¾
            showTab('stock');
            
            // å¡«å…¥è‚¡ç¥¨ä»£ç å¹¶æ‰§è¡Œåˆ†æ
            document.getElementById('ticker').value = symbol;
            searchStock();
        }
        
        // æ·»åŠ åˆ°å…³æ³¨åˆ—è¡¨
        async function addToWatchlist(symbol) {
            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            try {
                const response = await fetch('/auth/watchlist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        name: `å…³æ³¨ ${symbol}`
                    })
                });
                
                if (response.ok) {
                    alert(`${symbol} å·²æ·»åŠ åˆ°å…³æ³¨åˆ—è¡¨`);
                } else {
                    const error = await response.json();
                    alert(`æ·»åŠ å¤±è´¥: ${error.detail || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('æ·»åŠ å…³æ³¨å¤±è´¥:', error);
                alert('æ·»åŠ å…³æ³¨å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        // ==================== å¤šè¯­è¨€å’Œè®¾ç½®åŠŸèƒ½ ====================
        
        let currentLanguage = localStorage.getItem('language') || 'zh';
        let translations = {};
        
        // åŠ è½½ç¿»è¯‘æ–‡æœ¬
        async function loadTranslations(lang) {
            try {
                const response = await fetch(`/api/translations/${lang}`);
                const data = await response.json();
                if (data.success) {
                    translations = data.data;
                    updateUI();
                }
            } catch (error) {
                console.error('Failed to load translations:', error);
            }
        }
        
        // æ›´æ–°ç•Œé¢æ–‡æœ¬
        function updateUI() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[key]) {
                    element.textContent = translations[key];
                }
            });
        }
        
        // åˆ‡æ¢è¯­è¨€
        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            loadTranslations(lang);
            
            // æ›´æ–°è¯­è¨€é€‰æ‹©å™¨
            document.getElementById('languageSelect').value = lang;
            
            // é‡æ–°åŠ è½½æ–°é—»ï¼ˆå¦‚æœéœ€è¦ç¿»è¯‘ï¼‰
            if (document.getElementById('dashboardTab').classList.contains('tab-content') && !document.getElementById('dashboardTab').classList.contains('hidden')) {
                loadTranslatedNews();
            }
        }
        
        // åŠ è½½ç¿»è¯‘åçš„æ–°é—»
        async function loadTranslatedNews() {
            try {
                const autoTranslate = document.getElementById('autoTranslateNews').checked;
                const lang = autoTranslate ? currentLanguage : 'en';
                
                document.getElementById('newsLoading').classList.remove('hidden');
                document.getElementById('newsData').classList.add('hidden');
                
                const response = await fetch(`/api/market-updates/translated?lang=${lang}`);
                const newsData = await response.json();
                displayNews(newsData, 'market');
                
                document.getElementById('newsLoading').classList.add('hidden');
                document.getElementById('newsData').classList.remove('hidden');
            } catch (error) {
                console.error('Failed to load translated news:', error);
                document.getElementById('newsLoading').classList.add('hidden');
            }
        }
        
        // ä¿å­˜è®¾ç½®
        async function saveSettings() {
            try {
                const settings = {
                    language: document.getElementById('languageSelect').value,
                    auto_translate_news: document.getElementById('autoTranslateNews').checked
                };
                
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    // åˆ‡æ¢è¯­è¨€
                    switchLanguage(settings.language);
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    document.getElementById('settingsSuccess').classList.remove('hidden');
                    setTimeout(() => {
                        document.getElementById('settingsSuccess').classList.add('hidden');
                    }, 3000);
                }
            } catch (error) {
                console.error('Failed to save settings:', error);
            }
        }
        
        // åˆå§‹åŒ–è®¾ç½®
        async function initializeSettings() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                
                document.getElementById('languageSelect').value = settings.language || 'zh';
                document.getElementById('autoTranslateNews').checked = settings.auto_translate_news !== false;
                
                // è®¾ç½®å½“å‰è¯­è¨€
                currentLanguage = settings.language || 'zh';
                localStorage.setItem('language', currentLanguage);
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–è®¾ç½®
            initializeSettings();
            
            // åŠ è½½ç¿»è¯‘
            loadTranslations(currentLanguage);
            
            // è¯­è¨€é€‰æ‹©å™¨äº‹ä»¶
            document.getElementById('languageSelect').addEventListener('change', function() {
                switchLanguage(this.value);
            });
            
            // ä¿å­˜è®¾ç½®æŒ‰é’®
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            
            // è‡ªåŠ¨ç¿»è¯‘æ–°é—»å¤é€‰æ¡†
            document.getElementById('autoTranslateNews').addEventListener('change', function() {
                if (document.getElementById('dashboardTab').classList.contains('tab-content') && !document.getElementById('dashboardTab').classList.contains('hidden')) {
                    loadTranslatedNews();
                }
            });
        });
        
        // ä¿®æ”¹åŸæœ‰çš„loadNewså‡½æ•°ï¼Œæ”¯æŒç¿»è¯‘
        const originalLoadNews = loadNews;
        loadNews = async function(type = 'market', ticker = null) {
            try {
                const autoTranslate = document.getElementById('autoTranslateNews') ? document.getElementById('autoTranslateNews').checked : true;
                const lang = autoTranslate ? currentLanguage : 'en';
                
                document.getElementById('newsLoading').classList.remove('hidden');
                document.getElementById('newsData').classList.add('hidden');
                document.getElementById('newsError').classList.add('hidden');
                
                let url;
                if (type === 'stock' && ticker) {
                    url = `/stock-updates/${ticker}`;
                } else {
                    url = `/api/market-updates/translated?lang=${lang}`;
                }
                
                const response = await fetch(url);
                if (response.ok) {
                    const newsData = await response.json();
                    displayNews(newsData, type);
                } else {
                    throw new Error('æ— æ³•è·å–æ–°é—»æ•°æ®');
                }
            } catch (error) {
                console.error('æ–°é—»åŠ è½½å¤±è´¥:', error);
                document.getElementById('newsLoading').classList.add('hidden');
                document.getElementById('newsError').classList.remove('hidden');
                document.getElementById('newsErrorText').textContent = error.message;
            }
        };

    </script>
</body>
</html>